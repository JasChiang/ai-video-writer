# 頻道分析優化測試指南

## 📋 測試目的

這個自動化測試可以幫助你：
1. ✅ 驗證優化後的功能正常運作
2. 📊 確認 API 配額大幅節省（預期節省 90%+）
3. 🔍 測試關鍵字搜尋功能
4. 🎯 確認結果完整性（包含所有隱私狀態）

## 🚀 快速開始

### 1. 設定環境變數

在 `.env` 檔案中新增測試用的憑證：

```bash
TEST_ACCESS_TOKEN=your_youtube_oauth_access_token
TEST_CHANNEL_ID=your_channel_id
```

**如何取得這些資訊：**

- **TEST_ACCESS_TOKEN**:
  - 登入你的應用程式
  - 開啟瀏覽器開發者工具 (F12)
  - 找到 YouTube API 請求，複製 Authorization header 中的 token
  - 或從你的 OAuth 流程中取得

- **TEST_CHANNEL_ID**:
  - 前往你的 YouTube 頻道
  - 從 URL 中取得，格式類似：`UC...` 或 `@your-channel-name`
  - 或從 YouTube Studio > 設定 > 頻道 > 進階設定中找到

### 2. 執行測試

```bash
npm run test:quota
```

或直接執行：

```bash
node test-channel-analytics-optimization.js
```

## 📊 測試輸出範例

```
================================================================================
📊 頻道分析優化測試
================================================================================

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 測試案例: 所有影片
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🚀 測試新方法：playlistItems.list + 客戶端篩選
────────────────────────────────────────────────────────────────
   📂 上傳播放清單 ID: UU...

   📄 獲取第 1 頁...
   💰 配額: +2 (累計: 3)
   💰 配額: +4 (累計: 7)
      ✓ 獲取 50 支影片（累計: 50）

   📄 獲取第 2 頁...
   💰 配額: +2 (累計: 9)
   💰 配額: +4 (累計: 13)
      ✓ 獲取 50 支影片（累計: 100）

   ...

   ✅ 完成！共獲取 200 支影片

   🎯 過濾結果: 200 支影片符合條件

⚠️  模擬舊方法：search.list（僅計算配額，不實際執行）
────────────────────────────────────────────────────────────────
   📊 估算需要 4 次 search.list 請求
   💰 估算配額成本: 400 點

────────────────────────────────────────────────────────────────
📊 配額使用比較
────────────────────────────────────────────────────────────────
   舊方法 (search.list):          400 配額點數
   新方法 (playlistItems.list):    17 配額點數
   節省:                           383 配額點數
   節省比例:                      95.8%

✅ 功能驗證：
   ✓ 成功獲取 200 支影片
   ✓ 關鍵字過濾正常運作
   ✓ 包含各種隱私狀態的影片
   ✓ 隱私狀態統計: { public: 180, unlisted: 15, private: 5 }

================================================================================
✅ 測試完成！
================================================================================

主要發現：
1. ✅ 新方法能正確獲取所有影片
2. ✅ 關鍵字過濾功能正常
3. ✅ 配額成本大幅降低（節省 90%+ 配額）
4. ✅ 支援所有隱私狀態的影片（公開/未列出/私人）

建議：可以放心使用優化後的實作！
```

## 🎯 配額節省效果

| 影片數量 | 舊方法 (search.list) | 新方法 (playlistItems.list) | 節省 | 節省比例 |
|---------|---------------------|----------------------------|-----|---------|
| 50      | 100-200 點          | 5 點                       | 95-195 點 | 95-98% |
| 200     | 400-800 點          | 17 點                      | 383-783 點 | 95-98% |
| 500     | 1000-2000 點        | 41 點                      | 959-1959 點 | 95-98% |
| 1000    | 2000-4000 點        | 81 點                      | 1919-3919 點 | 95-98% |

## 📝 注意事項

1. **配額限制**: YouTube Data API v3 每日配額限制為 10,000 點
2. **測試頻率**: 避免頻繁測試以節省配額
3. **Access Token**: Token 會過期，需要定期更新
4. **測試範圍**: 腳本預設只測試一組關鍵字以節省配額

## 🔧 自訂測試

如需測試更多關鍵字，可以修改 `test-channel-analytics-optimization.js` 中的：

```javascript
// 第 164 行附近
const testKeywords = ['教學', 'tutorial', ''];  // 添加更多關鍵字
```

## 💡 整合到 CI/CD

你可以將此測試整合到 GitHub Actions：

```yaml
- name: Test Quota Optimization
  env:
    TEST_ACCESS_TOKEN: ${{ secrets.TEST_ACCESS_TOKEN }}
    TEST_CHANNEL_ID: ${{ secrets.TEST_CHANNEL_ID }}
  run: npm run test:quota
```

## 📚 相關檔案

- `test-channel-analytics-optimization.js` - 測試腳本
- `services/channelAnalyticsService.js` - 優化後的服務
- `services/quotaTracker.js` - 配額追蹤器

## ❓ 常見問題

### Q: 測試失敗怎麼辦？
A: 檢查：
1. Access Token 是否有效
2. Channel ID 是否正確
3. 是否有足夠的 API 配額
4. 網路連線是否正常

### Q: 配額不夠怎麼辦？
A:
1. 等待隔天配額重置
2. 申請更高的配額限制
3. 使用測試專用的 API 金鑰

### Q: 如何在生產環境監控配額？
A: 使用內建的 `quotaTracker.js`：

```javascript
import { getQuotaSnapshot } from './services/quotaTracker.js';

// 在需要的地方查看配額使用
const snapshot = getQuotaSnapshot();
console.log('今日已使用配額:', snapshot.totalUnits);
```

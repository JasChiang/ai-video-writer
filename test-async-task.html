<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç•°æ­¥ä»»å‹™ç³»çµ±æ¸¬è©¦</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .output {
      margin-top: 15px;
      padding: 15px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background: #4CAF50;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
    }
    .status {
      padding: 5px 10px;
      border-radius: 4px;
      display: inline-block;
      margin: 5px 0;
      font-size: 12px;
    }
    .status.pending { background: #ffa726; color: white; }
    .status.processing { background: #42a5f5; color: white; }
    .status.completed { background: #4CAF50; color: white; }
    .status.failed { background: #ef5350; color: white; }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”¬ ç•°æ­¥ä»»å‹™ç³»çµ±æ¸¬è©¦</h1>

    <div class="warning">
      âš ï¸ <strong>æ³¨æ„</strong>ï¼šè«‹ç¢ºä¿å¾Œç«¯ä¼ºæœå™¨æ­£åœ¨é‹è¡Œï¼ˆé è¨­: http://localhost:3001ï¼‰
    </div>

    <!-- Test 1: æŸ¥è©¢ä»»å‹™ç‹€æ…‹ -->
    <div class="test-section">
      <h3>æ¸¬è©¦ 1: æŸ¥è©¢ä»»å‹™ç‹€æ…‹</h3>
      <p>è¼¸å…¥ Task ID æŸ¥è©¢ç‹€æ…‹ï¼š</p>
      <input type="text" id="taskId" placeholder="task_xxxxx" style="width: 300px; padding: 8px;">
      <button onclick="getTaskStatus()">æŸ¥è©¢ç‹€æ…‹</button>
      <div id="statusOutput" class="output" style="display: none;"></div>
    </div>

    <!-- Test 2: å‰µå»ºæ¸¬è©¦ä»»å‹™ -->
    <div class="test-section">
      <h3>æ¸¬è©¦ 2: å‰µå»ºæ–‡ç« ç”Ÿæˆä»»å‹™</h3>
      <p>è¼¸å…¥ YouTube å½±ç‰‡ IDï¼š</p>
      <input type="text" id="videoId" placeholder="dQw4w9WgXcQ" value="dQw4w9WgXcQ" style="width: 300px; padding: 8px;">
      <br><br>
      <button onclick="createTask()" id="createBtn">å‰µå»ºä»»å‹™</button>
      <button onclick="stopPolling()" id="stopBtn" disabled>åœæ­¢è¼ªè©¢</button>

      <div id="taskProgress" style="display: none; margin-top: 15px;">
        <p>ä»»å‹™ ID: <strong id="currentTaskId"></strong></p>
        <p>ç‹€æ…‹: <span id="taskStatusBadge" class="status pending">pending</span></p>
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill" style="width: 0%">0%</div>
        </div>
        <p id="progressMessage" style="color: #666; font-size: 14px;"></p>
      </div>

      <div id="taskOutput" class="output" style="display: none;"></div>
    </div>

    <!-- Test 3: ç³»çµ±ä¿¡æ¯ -->
    <div class="test-section">
      <h3>æ¸¬è©¦ 3: ç³»çµ±æª¢æŸ¥</h3>
      <button onclick="checkSystem()">æª¢æŸ¥ç³»çµ±</button>
      <div id="systemOutput" class="output" style="display: none;"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001/api';
    let pollingInterval = null;

    // æŸ¥è©¢ä»»å‹™ç‹€æ…‹
    async function getTaskStatus() {
      const taskId = document.getElementById('taskId').value.trim();
      if (!taskId) {
        alert('è«‹è¼¸å…¥ Task ID');
        return;
      }

      const output = document.getElementById('statusOutput');
      output.style.display = 'block';
      output.textContent = 'æ­£åœ¨æŸ¥è©¢...';

      try {
        const response = await fetch(`${API_BASE}/task/${taskId}`);
        const data = await response.json();

        if (response.ok) {
          output.textContent = JSON.stringify(data, null, 2);
        } else {
          output.textContent = `âŒ éŒ¯èª¤: ${data.error}`;
        }
      } catch (error) {
        output.textContent = `âŒ è«‹æ±‚å¤±æ•—: ${error.message}`;
      }
    }

    // å‰µå»ºä»»å‹™
    async function createTask() {
      const videoId = document.getElementById('videoId').value.trim();
      if (!videoId) {
        alert('è«‹è¼¸å…¥ YouTube å½±ç‰‡ ID');
        return;
      }

      const createBtn = document.getElementById('createBtn');
      const stopBtn = document.getElementById('stopBtn');
      const output = document.getElementById('taskOutput');
      const progress = document.getElementById('taskProgress');

      createBtn.disabled = true;
      stopBtn.disabled = false;
      output.style.display = 'none';
      progress.style.display = 'block';

      try {
        // å‰µå»ºä»»å‹™
        const response = await fetch(`${API_BASE}/generate-article-url-async`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            videoId: videoId,
            prompt: 'æ¸¬è©¦ç”Ÿæˆ',
            videoTitle: 'æ¸¬è©¦å½±ç‰‡',
            quality: 2
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'å‰µå»ºä»»å‹™å¤±æ•—');
        }

        document.getElementById('currentTaskId').textContent = data.taskId;
        updateProgress(0, 'ä»»å‹™å·²å‰µå»ºï¼Œé–‹å§‹åŸ·è¡Œ...');

        // é–‹å§‹è¼ªè©¢
        startPolling(data.taskId);

      } catch (error) {
        alert(`å‰µå»ºä»»å‹™å¤±æ•—: ${error.message}`);
        createBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    // é–‹å§‹è¼ªè©¢
    function startPolling(taskId) {
      let pollCount = 0;
      pollingInterval = setInterval(async () => {
        pollCount++;

        try {
          const response = await fetch(`${API_BASE}/task/${taskId}`);
          const task = await response.json();

          if (!response.ok) {
            throw new Error(task.error || 'æŸ¥è©¢å¤±æ•—');
          }

          // æ›´æ–°é€²åº¦
          updateProgress(task.progress, task.progressMessage);
          updateStatus(task.status);

          // æª¢æŸ¥æ˜¯å¦å®Œæˆ
          if (task.status === 'completed') {
            stopPolling();
            showResult(task.result);
            alert('âœ… ä»»å‹™å®Œæˆï¼');
          } else if (task.status === 'failed') {
            stopPolling();
            alert(`âŒ ä»»å‹™å¤±æ•—: ${task.error}`);
          }

          // è¶…æ™‚ä¿è­·ï¼ˆ5åˆ†é˜ï¼‰
          if (pollCount > 150) {
            stopPolling();
            alert('â±ï¸ è¼ªè©¢è¶…æ™‚ï¼Œè«‹æ‰‹å‹•æŸ¥è©¢ä»»å‹™ç‹€æ…‹');
          }

        } catch (error) {
          console.error('è¼ªè©¢éŒ¯èª¤:', error);
        }
      }, 2000); // æ¯ 2 ç§’è¼ªè©¢ä¸€æ¬¡
    }

    // åœæ­¢è¼ªè©¢
    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
      document.getElementById('createBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    }

    // æ›´æ–°é€²åº¦
    function updateProgress(progress, message) {
      const fill = document.getElementById('progressFill');
      const msg = document.getElementById('progressMessage');

      fill.style.width = `${progress}%`;
      fill.textContent = `${progress}%`;
      msg.textContent = message || '';
    }

    // æ›´æ–°ç‹€æ…‹æ¨™ç±¤
    function updateStatus(status) {
      const badge = document.getElementById('taskStatusBadge');
      badge.className = `status ${status}`;
      badge.textContent = status;
    }

    // é¡¯ç¤ºçµæœ
    function showResult(result) {
      const output = document.getElementById('taskOutput');
      output.style.display = 'block';
      output.textContent = JSON.stringify(result, null, 2);
    }

    // ç³»çµ±æª¢æŸ¥
    async function checkSystem() {
      const output = document.getElementById('systemOutput');
      output.style.display = 'block';
      output.textContent = 'æ­£åœ¨æª¢æŸ¥ç³»çµ±...\n\n';

      const tests = [
        {
          name: 'å¾Œç«¯é€£æ¥',
          test: async () => {
            const response = await fetch(`${API_BASE.replace('/api', '')}/`);
            return response.ok;
          }
        },
        {
          name: 'ä»»å‹™ API',
          test: async () => {
            const response = await fetch(`${API_BASE}/task/test_invalid_id`);
            return response.status === 404; // é æœŸ 404
          }
        }
      ];

      for (const test of tests) {
        try {
          const result = await test.test();
          output.textContent += `âœ… ${test.name}: ${result ? 'é€šé' : 'å¤±æ•—'}\n`;
        } catch (error) {
          output.textContent += `âŒ ${test.name}: éŒ¯èª¤ - ${error.message}\n`;
        }
      }

      output.textContent += '\næª¢æŸ¥å®Œæˆï¼';
    }

    // é é¢å¸è¼‰æ™‚åœæ­¢è¼ªè©¢
    window.addEventListener('beforeunload', stopPolling);
  </script>
</body>
</html>

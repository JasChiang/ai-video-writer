/**
 * Prompt Templates - 為不同分析類型生成專業的 AI 分析提示詞
 * 基於「增長飛輪」理論框架，已根據 YouTube API 限制調整
 *
 * ⚠️ YouTube API 限制說明：
 * - ❌ 無法取得：CTR、曝光次數、詳細續看率曲線、每部影片訂閱增減
 * - ✅ 可用數據：觀看數、按讚數、留言數、平均觀看時長、流量來源、訂閱者總增減
 */

export class PromptTemplates {
  /**
   * 生成分析提示詞（主入口）
   */
  static generatePrompt(data) {
    const baseContext = this.buildBaseContext(data);

    switch (data.type) {
      case 'subscriber-growth':
        return this.buildSubscriberGrowthPrompt(baseContext, data);

      case 'view-optimization':
        return this.buildViewOptimizationPrompt(baseContext, data);

      case 'content-strategy':
        return this.buildContentStrategyPrompt(baseContext, data);

      case 'audience-insights':
        return this.buildAudienceInsightsPrompt(baseContext, data);

      case 'comprehensive':
        return this.buildComprehensivePrompt(baseContext, data);

      default:
        throw new Error(`Unknown analysis type: ${data.type}`);
    }
  }

  /**
   * 建立基礎上下文（所有分析共用）
   * 加入「內容效率」指標
   */
  static buildBaseContext(data) {
    const { dateRange, channelStats, videos } = data;

    const totalViews = videos.reduce((sum, v) => sum + v.viewCount, 0);
    const totalLikes = videos.reduce((sum, v) => sum + v.likeCount, 0);
    const totalComments = videos.reduce((sum, v) => sum + v.commentCount, 0);
    const avgViews = videos.length > 0 ? totalViews / videos.length : 0;

    // 內容效率指標
    const contentEfficiency = channelStats.subscriberCount / channelStats.totalVideos;
    const engagementRate = totalViews > 0 ? ((totalLikes + totalComments) / totalViews * 100) : 0;
    const avgLikeRate = totalViews > 0 ? (totalLikes / totalViews * 100) : 0;

    return `
**YouTube 增長飛輪核心原理**
YouTube 演算法的目標是最大化「總觀看時長」，而非觀看次數。頻道增長的關鍵是建立良性循環：
高品質內容 → 高觀看時長 → 演算法推薦 → 更多曝光 → 更多觀看 → 訂閱增長 → 飛輪加速

**頻道數據概覽**
- 分析期間：${dateRange.startDate} ~ ${dateRange.endDate}
- 總訂閱者數：${channelStats.subscriberCount.toLocaleString()}
- 頻道總觀看次數：${channelStats.totalViews.toLocaleString()}
- 頻道總影片數：${channelStats.totalVideos}
- **內容效率（訂閱者/影片比）：${contentEfficiency.toFixed(1)}**
  ↳ 此指標衡量每部影片帶來訂閱的效率。業界標竿：100+ 為優秀，50-100 為良好，<20 需改善

**分析期間表現**
- 分析影片數：${videos.length}
- 總觀看次數：${totalViews.toLocaleString()}
- 總按讚數：${totalLikes.toLocaleString()}
- 總留言數：${totalComments.toLocaleString()}
- 平均每部影片觀看次數：${Math.round(avgViews).toLocaleString()}
- **整體互動率：${engagementRate.toFixed(2)}%**（按讚+留言/觀看）
- **平均按讚率：${avgLikeRate.toFixed(2)}%**（按讚/觀看）

**影片清單（含效率指標）：**
${videos
  .map((v, idx) => {
    const likeRate = v.viewCount > 0 ? (v.likeCount / v.viewCount * 100) : 0;
    const commentRate = v.viewCount > 0 ? (v.commentCount / v.viewCount * 100) : 0;
    return `${idx + 1}. **${v.title}** (${v.publishedAt.split('T')[0]})
   - 觀看：${v.viewCount.toLocaleString()} | 按讚：${v.likeCount.toLocaleString()} (${likeRate.toFixed(2)}%) | 留言：${v.commentCount} (${commentRate.toFixed(2)}%)
   - 標籤：${v.tags?.join(', ') || '無'}`;
  })
  .join('\n\n')}
`;
  }

  /**
   * 訂閱成長分析提示詞
   * 核心：找出「訂閱磁鐵」影片，強化系列化內容策略
   */
  static buildSubscriberGrowthPrompt(baseContext, data) {
    return `**分析角色：** YouTube 頻道訂閱成長策略專家

**核心使命：** 診斷訂閱轉換效率，識別「訂閱磁鐵」影片，提供系統性訂閱增長策略

${baseContext}

**訂閱增長數據：**
${data.analytics?.subscribersGained ? `- 期間新增訂閱者：${data.analytics.subscribersGained.toLocaleString()}` : ''}
${data.analytics?.subscribersLost ? `- 期間流失訂閱者：${data.analytics.subscribersLost.toLocaleString()}` : ''}
${
  data.analytics?.subscribersGained && data.analytics?.subscribersLost
    ? `- 淨增訂閱者：${(data.analytics.subscribersGained - data.analytics.subscribersLost).toLocaleString()}`
    : ''
}
${
  data.analytics?.subscribersGained
    ? `- **訂閱轉換率：${((data.analytics.subscribersGained / data.videos?.reduce((sum, v) => sum + v.viewCount, 0)) * 100).toFixed(3)}%**
  ↳ 業界基準：每 80-100 次觀看獲得 1 訂閱（轉換率 1%-1.25%）為良好`
    : ''
}

**⚠️ 分析限制與策略**
- YouTube API 無法提供「每部影片帶來的訂閱數」，但可透過以下代理指標推論「訂閱磁鐵」：
  1. **高觀看數 + 高互動率**（按讚率 > 5%、留言率 > 0.5%）的影片
  2. **完整標題含「系列」、「第X集」、「教學」等關鍵字**的影片（暗示觀眾期待後續內容）
  3. **發布後訂閱增長加速**的時間段（需結合整體趨勢推論）

**核心分析任務：**

## 1. 訂閱磁鐵影片識別（基於代理指標）
- 分析哪些影片同時具備「高觀看數」與「高互動率」（按讚率 + 留言率）
- 這些影片的共同特徵：
  * 內容主題（3C 評測？健康知識？AI 應用？）
  * 標題結構（是否使用「如何...」、「必學...」、「全攻略」等實用型關鍵字？）
  * 內容深度（影片長度、標籤數量、是否為系列內容？）
  * 發布時間模式
- **關鍵洞察：** 高互動率 = 觀眾滿意度高 = 更可能訂閱

## 2. 系列化內容 vs 一次性內容分析
- **核心理論：** 系列化內容的訂閱轉換率顯著高於一次性內容，因為觀眾會「期待下一集」
- 分析任務：
  * 識別頻道是否有明確的「系列節目」（例如：固定主持人、固定主題、固定播出節奏）
  * 對比「系列內容」與「獨立單集」的平均觀看表現和互動率
  * 評估：頻道是否過度依賴「一次性」、「精華剪輯」、「速報」類型的內容？
- **行動建議：**
  * 若缺乏系列內容，建議將表現最好的主題（見任務 1）發展為帶狀節目
  * 提供具體的系列規劃範例（例如：每週固定時間、固定主持人、固定單元）

## 3. 訂閱者流失風險評估
- 分析可能導致退訂的因素：
  * 內容主題是否過於分散、缺乏定位？（例如：同時做 3C、美食、旅遊）
  * 發片頻率是否不穩定？（長時間斷更會導致觀眾遺忘）
  * 是否有「低互動率」（按讚率 < 1%）的影片？這可能代表內容品質下滑
- 識別「高風險」影片類型，建議減少或優化

## 4. 訂閱行動呼籲 (CTA) 策略
- 雖然無法直接測量 CTA 效果，但可基於標題和標籤推論：
  * 影片是否在標題/描述中包含「訂閱」、「追蹤」等關鍵字？
  * 是否有清晰的「下一集預告」或「播放列表」引導？
- 提供 CTA 優化建議（例如：在影片前 30 秒和結尾加入訂閱提醒）

## 5. 訂閱增長行動方案
基於以上分析，提供 **5 個具體、可執行的策略**，優先順序排序：
1. 訂閱磁鐵內容放大（將高互動影片主題製作成系列）
2. 系列化節目規劃（固定主持人、固定時間、固定主題）
3. 發片節奏優化（建議頻率和時間）
4. 低效內容削減（停止製作低互動率的內容類型）
5. CTA 和播放列表優化

**輸出格式要求：**

## 📈 訂閱轉換現況診斷
（分析當前轉換率、與基準對比、增長趨勢評估）

## 🎯 訂閱磁鐵影片識別（Top 5）
（列出前 5 名高潛力影片，說明其成功因素和共同特徵）

## 📺 系列化內容評估
（評估頻道的系列化程度、一次性內容比例、系列化機會）

## ⚠️ 訂閱流失風險警訊
（識別可能導致退訂的因素、高風險內容類型）

## 🚀 訂閱增長行動方案（5 大策略）
（每個策略包含：目標、執行步驟、預期成效）

**撰寫規範：**
- 使用台灣繁體中文
- 每項建議必須有數據支持（引用具體影片範例）
- 提供可量化目標（例如：3 個月內將轉換率從 0.8% 提升至 1.2%）
- 中文、英文、數字之間加上半形空格
`;
  }

  /**
   * 觀看優化分析提示詞
   * 核心：增長飛輪診斷、YouTube SEO 優化、流量來源分析
   */
  static buildViewOptimizationPrompt(baseContext, data) {
    return `**分析角色：** YouTube 演算法優化與流量增長專家

**核心使命：** 診斷增長飛輪運轉狀態，優化標題/標籤/描述，提升演算法推薦率

${baseContext}

**觀看表現數據：**
${data.analytics?.avgViewDuration ? `- 平均觀看時長：${Math.round(data.analytics.avgViewDuration)} 秒` : ''}
${data.analytics?.avgViewPercentage ? `- 平均觀看百分比：${data.analytics.avgViewPercentage.toFixed(1)}%` : ''}

**流量來源分佈：**
${
  data.analytics?.trafficSources
    ? data.analytics.trafficSources
        .map(
          (source) =>
            `- ${source.sourceType}: ${source.views.toLocaleString()} 次觀看 (${source.percentage.toFixed(1)}%)`
        )
        .join('\n')
    : '（未提供流量來源數據，將基於其他指標進行推論）'
}

**⚠️ YouTube API 限制與替代策略**
- ❌ 無法取得：曝光點閱率 (CTR)、曝光次數、詳細續看率曲線
- ✅ 替代指標：
  1. **互動率（按讚率 + 留言率）** → 代理內容吸引力與滿意度
  2. **觀看數 + 互動率組合** → 推論演算法推薦力度
  3. **標題/標籤分析** → 推論 YouTube SEO 優化空間
  4. **流量來源** → 診斷頻道的「曝光體質」

**增長飛輪診斷框架**
良性循環：高品質內容 → 高觀看時長 → 演算法推薦 → 更多曝光 → 高點閱 → 更多觀看 → 飛輪加速
惡性循環：低品質內容 → 低觀看時長 → 演算法懲罰 → 曝光停止 → 觀看停滯 → 飛輪卡死

**核心分析任務：**

## 1. 流量來源診斷：頻道的「曝光體質」分析
- **YouTube 搜尋 (Search) 流量高**：
  * 意義：YouTube SEO 成功，觀眾能透過主動搜尋找到內容
  * ⚠️ 警訊：若「搜尋」高但「推薦影片」低，代表觀眾「用完即走」，內容黏著度不足
  * 行動：優化內容深度、加入系列化設計、強化播放列表

- **推薦影片 / 瀏覽功能 (Suggested / Browse) 流量高**：
  * 意義：✅ 最健康的狀態！演算法正在主動推薦，增長飛輪高速運轉
  * 行動：維持內容品質，分析這些影片的成功因素並複製

- **外部 (External) 流量高**（如：來自官網、Facebook）：
  * 意義：⚠️ 頻道僅被當作「影片播放器」，未能利用 YouTube 生態系統
  * 行動：強化 YouTube 內部 SEO 和推薦策略，減少對外部流量的依賴

- **頻道頁面 (Channel Pages) 流量高**：
  * 意義：現有訂閱者忠誠度高，但新觀眾獲取不足
  * 行動：優化標題和標籤以提升搜尋曝光

## 2. YouTube SEO 優化診斷與建議
分析所有影片的標題、標籤、描述，評估 SEO 優化程度：

### 標題 (Title) 優化
- **關鍵字前置原則：** 核心關鍵字是否在標題前半部？
- **吸引力法則：** 是否使用「數字下標法」（10 個...技巧）、「實用錦囊法」（如何解決...）、「對決法」（A vs B）？
- **切題性：** 標題是否過於模糊或誇大？（會導致觀眾快速離開，演算法懲罰）
- **範例對比：**
  * ❌ 低效：「【最速報】新手機發布」
  * ✅ 高效：「OPPO Find X9 深度評測：2 億畫素哈蘇鏡頭值得買嗎？｜ 5 大優缺點實測」

### 標籤 (Tags) 優化
- 標籤是否與影片內容高度相關？
- 是否包含「長尾關鍵字」（例如：「AI 筆電推薦 2025」而非只有「AI」）？
- 建議：分析競品（如：電腦王阿達、3C Tim 哥）的高觀看影片標籤

### 描述 (Description) 優化
- 前 80 字是否簡潔總結影片並包含行動呼籲 (CTA)？
- 是否加入「時間戳記」（Time Stamps）？（對長影片至關重要，可提升續看率）
- 是否加入內部連結（引導觀看更多影片）和外部連結（引導至產品頁）？

## 3. 內容吸引力分析（互動率代理 CTR）
由於無法取得真實 CTR，使用以下代理指標評估「標題 + 縮圖」的吸引力：
- **高觀看 + 高互動 = 高吸引力**（演算法推薦且觀眾滿意）
- **高觀看 + 低互動 = 點擊誘餌**（演算法可能已標記並減少推薦）
- **低觀看 + 高互動 = SEO 不足**（內容好但曝光少，需優化標題/標籤）
- **低觀看 + 低互動 = 失敗內容**（刪除或重製）

分析各影片落在哪個象限，提供針對性優化建議。

## 4. 觀看時長優化策略
- 分析「高觀看時長」影片的共同特徵：
  * 影片長度（短影片 vs 長影片）
  * 內容結構（是否有清晰的章節？）
  * 節奏控制（是否有明顯的拖沓段落？）
- 提供內容結構優化建議（例如：黃金開場 30 秒、中段高潮、結尾 CTA）

## 5. 發布時間與頻率優化
- 基於影片發布時間和表現數據，分析最佳發布時段
- 評估發片頻率的穩定性（演算法偏好穩定更新的頻道）
- 建議：建立「內容日曆」，固定發片時間以建立觀眾習慣

## 6. 縮圖優化建議（基於高表現影片推論）
雖然無法直接測量 CTR，但可分析高觀看影片的標題模式，推論縮圖策略：
- 建議使用：高對比色彩、清晰易讀的文字、人臉特寫、產品對決畫面
- 避免：純官方產品圖、過於複雜的畫面

**輸出格式要求：**

## 📊 增長飛輪診斷：當前運轉狀態
（診斷飛輪是否運轉、卡在哪個環節、流量來源健康度評估）

## 🔍 YouTube SEO 優化診斷
（標題/標籤/描述的優化空間、具體範例、競品對比）

## 🎯 高表現影片成功因素
（列出前 5 名高觀看影片，分析其標題、主題、SEO 策略）

## ⚠️ 優化機會點與風險警訊
（低互動影片、點擊誘餌風險、SEO 缺失）

## 🚀 觀看次數提升行動方案（7 大策略）
1. 流量來源優化（降低外部依賴、提升推薦流量）
2. 標題優化模板和範例
3. 標籤與 SEO 關鍵字策略
4. 描述欄與時間戳記優化
5. 內容結構與觀看時長優化
6. 發布時間與頻率建議
7. 縮圖優化原則

**撰寫規範：**
- 使用台灣繁體中文
- 提供可量化目標（例如：3 個月內將推薦流量從 20% 提升至 40%）
- 每個建議都有具體範例和執行步驟
- 中文、英文、數字之間加上半形空格
`;
  }

  /**
   * 內容策略分析提示詞
   * 核心：內容效率 vs 內容數量、常青樹內容策略、競品對比
   */
  static buildContentStrategyPrompt(baseContext, data) {
    return `**分析角色：** YouTube 內容策略顧問與資源配置專家

**核心使命：** 診斷內容效率，識別「內容黑洞」，提供長期內容發展策略

${baseContext}

**內容效率核心理論**
❌ 錯誤思維：「發布越多影片，頻道成長越快」
✅ 正確思維：「1 支高品質影片 > 10 支低效率影片」

**內容效率公式：**
- **訂閱者 / 影片比**（見上方基礎數據）：每部影片帶來的訂閱效率
- **平均觀看數 / 影片**：內容的平均曝光能力
- **互動率**：內容的平均滿意度

**⚠️ 分析策略**
由於無法取得詳細的續看率曲線，將透過以下方式評估內容品質：
1. **觀看數 + 互動率組合** → 識別高效內容 vs 低效內容
2. **主題歸因分析** → 找出哪些主題表現最好
3. **內容長度分組對比** → 短影片 vs 長影片的效率差異
4. **時間序列分析** → 常青樹內容 vs 一次性內容

**核心分析任務：**

## 1. 內容主題分析與歸因
- 根據標題和標籤，識別頻道的主要內容支柱（例如：3C 評測、健康知識、AI 應用）
- 計算各主題的：
  * 影片數量
  * 平均觀看次數
  * 平均互動率（按讚率 + 留言率）
  * **效率評分**（平均觀看數 × 互動率）
- 識別：
  * **明星主題**（高觀看 + 高互動）→ 應加倍投入
  * **潛力主題**（低觀看 + 高互動）→ 需優化 SEO
  * **流量主題**（高觀看 + 低互動）→ 吸引點擊但內容品質需提升
  * **黑洞主題**（低觀看 + 低互動）→ 應停止或重製

## 2. 內容效率診斷：對抗「內容黑洞」
- **問題診斷：** 頻道是否陷入「高產量、低效率」的內容黑洞？
  * 對比「內容效率（訂閱者/影片比）」與業界標竿：
    - 優秀：100+
    - 良好：50-100
    - 需改善：20-50
    - 內容黑洞：<20
- **根因分析：**
  * 是否過度依賴「短影片」、「精華剪輯」、「速報」等淺層內容？
  * 是否缺乏「深度評測」、「全攻略」、「必學技巧」等高價值內容？
- **行動建議：**
  * 立即停止低效內容類型
  * 將資源從「製作 10 支 2 分鐘影片」轉向「製作 1 支 10 分鐘深度影片」

## 3. 常青樹內容 vs 一次性內容分析
- **常青樹內容 (Evergreen Content)：**
  * 定義：長期具有搜尋價值的內容（例如：「如何選購 AI 筆電」、「SAMSUNG Good Lock 完整教學」）
  * 特徵：發布後數月甚至數年仍持續帶來流量
  * 識別方式：發布時間較早但仍有穩定觀看數的影片

- **一次性內容：**
  * 定義：時效性內容（例如：「最速報：XX 新品發布」、「LIVE 精華」）
  * 特徵：發布後短期內流量快速下降

- **分析任務：**
  * 計算頻道的「常青樹內容比例」
  * 評估：是否過度依賴一次性內容？（導致必須持續高產量才能維持流量）
  * 建議：提升常青樹內容比例至 40% 以上

## 4. 內容缺口與系列化機會
- 分析頻道還缺少哪些相關主題（基於現有主題延伸）
- 識別適合發展成「系列節目」的主題：
  * 是否有可持續性？（能做 10 集以上）
  * 是否有觀眾期待？（高互動率）
  * 是否有競爭優勢？（頻道的專業領域）
- 提供具體的系列規劃範例（例如：「AI 實戰系列」每週一集，共 12 集）

## 5. 競品對比與差異化策略
- 基於頻道定位，建議可參考的競品（例如：電腦王阿達、PChome 24h、Joeman）
- 對比分析：
  * 競品的內容深度（影片平均長度）
  * 競品的內容類型（評測、開箱、教學、娛樂）
  * 競品的更新頻率
  * 競品的內容效率（訂閱者/影片比）
- 識別差異化機會：
  * 頻道的獨特優勢是什麼？（例如：實體門市、專業維修團隊、健康專家）
  * 如何將這些優勢轉化為獨特內容？

## 6. 資源配置建議
基於內容效率分析，提供資源重新配置方案：
- **停止製作：** 哪些低效內容類型應立即停止？
- **維持現狀：** 哪些內容表現穩定，維持現有投入即可？
- **加倍投入：** 哪些高效主題應增加預算和製作頻率?
- **策略轉型：** 建議的新內容方向（例如：從速報轉向深度評測）

**輸出格式要求：**

## 📊 內容主題分佈與效率分析
（各主題的數量、平均表現、效率評分、象限分類）

## ⚠️ 內容效率診斷：是否陷入「內容黑洞」？
（內容效率指標對比、根因分析、問題嚴重度評估）

## 🌲 常青樹內容 vs 一次性內容評估
（兩種內容的比例、表現對比、優化建議）

## 💡 內容缺口與系列化機會
（還可以製作哪些內容、系列化規劃範例）

## 🎯 競品對比與差異化策略
（競品分析、差異化機會、獨特優勢挖掘）

## 🚀 內容策略行動方案（5 大方向）
1. 停止製作：低效內容削減清單
2. 維持現狀：穩定內容維護策略
3. 加倍投入：高效主題資源配置
4. 策略轉型：從速報轉向深度內容
5. 系列化規劃：3 個系列節目企劃案

**撰寫規範：**
- 使用台灣繁體中文
- 提供具體的主題建議，而非籠統的方向
- 每個建議都要有預期效果評估和競品範例
- 中文、英文、數字之間加上半形空格
`;
  }

  /**
   * 觀眾洞察分析提示詞
   * 核心：觀眾黏性、固定發片節奏、社群互動策略
   */
  static buildAudienceInsightsPrompt(baseContext, data) {
    return `**分析角色：** 觀眾洞察分析師與社群經營專家

**核心使命：** 深入了解觀眾特徵和行為，提供精準的內容定位與觀眾黏性提升策略

${baseContext}

**觀眾特徵數據：**
${
  data.analytics?.demographics
    ? `\n**年齡與性別分佈：**\n${JSON.stringify(data.analytics.demographics, null, 2)}`
    : '（未提供人口統計數據）'
}

${
  data.analytics?.geography
    ? `\n**地理分佈：**\n${JSON.stringify(data.analytics.geography, null, 2)}`
    : '（未提供地理數據）'
}

${
  data.analytics?.devices
    ? `\n**設備使用分佈：**\n${JSON.stringify(data.analytics.devices, null, 2)}`
    : '（未提供設備數據）'
}

${
  data.analytics?.trafficSources
    ? `\n**流量來源：**\n${JSON.stringify(data.analytics.trafficSources, null, 2)}`
    : '（未提供流量來源數據）'
}

**⚠️ YouTube API 限制與替代策略**
- ❌ 無法取得：觀眾回訪率、訂閱者活躍度、個別觀眾行為軌跡
- ✅ 可用指標：人口統計、地理分佈、設備類型、流量來源、互動數據
- ✅ 間接評估：透過「發片節奏 vs 觀看數穩定性」推論觀眾黏性

**核心分析任務：**

## 1. 核心觀眾畫像建構
基於可用數據，建構詳細的觀眾畫像：
- **人口統計分析：**
  * 核心年齡層（佔比最高的年齡區間）
  * 性別分佈
  * 對內容定位的啟示（例如：25-34 歲男性為主 → 適合深度 3C 評測）

- **地理分佈分析：**
  * 主要市場（台灣、香港、其他華語地區？）
  * 潛力市場（次要但增長快速的地區）
  * 語言與文化適配建議

- **設備偏好分析：**
  * 手機 vs 電腦 vs 平板 vs 電視
  * 對內容格式的啟示：
    - 手機用戶高 → 適合 Shorts、直式影片、簡潔字幕
    - 電腦/電視用戶高 → 適合長影片、橫式影片、精緻畫面

## 2. 觀眾行為模式分析
- **流量來源行為推論：**
  * 搜尋流量高 → 觀眾是「問題解決導向」（看完即走）
  * 推薦流量高 → 觀眾是「興趣探索導向」（容易成為長期粉絲）
  * 頻道頁面流量高 → 現有訂閱者忠誠度高
  * 外部流量高 → 品牌粉絲，但未必是 YouTube 原生用戶

- **互動模式分析：**
  * 計算「留言率」高的影片類型（暗示觀眾參與意願）
  * 分析留言內容模式（若可存取）：詢問類 vs 讚美類 vs 建議類
  * 識別引發高互動的內容特徵（爭議性話題？實用教學？情感共鳴？）

## 3. 觀眾黏性間接評估
雖然無法直接取得回訪率，但可透過以下方式間接評估：
- **發片節奏 vs 觀看數穩定性分析：**
  * 若頻道「固定每週三發片」，觀看數是否穩定？
  * 若「不定期發片」，觀看數是否波動劇烈？
  * 推論：發片節奏穩定 + 觀看數穩定 = 觀眾已建立收看習慣 = 黏性高

- **訂閱者 vs 非訂閱者觀看比例推論：**
  * 若頻道頁面流量佔比高 → 訂閱者黏性高
  * 若搜尋/推薦流量佔比高 → 新觀眾多，但黏性待提升

## 4. 內容偏好洞察
基於不同觀眾群體的觀看表現，識別內容偏好：
- 分析不同主題在不同觀眾群體中的表現差異（若有人口統計數據）
- 識別「全年齡適用」vs「特定年齡層偏好」的內容
- 提供針對核心觀眾群體的內容主題、格式、風格建議

## 5. 觀眾黏性提升策略（6 大方向）
雖然無法直接測量黏性，但可透過以下策略系統性提升：

### 策略 1：固定發片節奏 - 建立觀看習慣
- 分析當前發片頻率的穩定性
- 建議：固定的「日期 + 時間」（例如：每週三晚上 8 點）
- 成效：觀眾會在固定時間「期待」新影片，建立收看習慣

### 策略 2：系列化內容 - 建立持續追蹤動機
- 將表現好的主題發展為「季播節目」（例如：第 1 季 12 集）
- 在每集結尾預告下一集內容，製造期待感
- 成效：觀眾會「訂閱」以追蹤後續內容

### 策略 3：社群互動 - 在留言區建立連結
- 分析當前的留言回覆率（頻道是否積極回覆留言？）
- 建議：
  * 在影片中主動提問（例如：「你認為哪個功能最實用？留言告訴我！」）
  * 固定回覆留言（每支影片至少回覆前 20 則）
  * 在下一支影片中提及觀眾留言（建立參與感）
- 成效：觀眾感受到「被重視」，提升社群歸屬感

### 策略 4：播放列表優化 - 增加連續觀看
- 檢視當前播放列表的組織方式
- 建議：依主題、系列、難易度建立清晰的播放列表
- 成效：觀眾會自動連播，提升總觀看時長

### 策略 5：觀眾參與機制 - 互動式內容
- 建議加入互動元素：
  * 問答 (Q&A)：蒐集觀眾問題製作專題影片
  * 投票：在社群貼文詢問觀眾想看的內容
  * 挑戰：邀請觀眾參與（例如：「分享你的 AI 應用案例」）
- 成效：觀眾從「被動消費」轉為「主動參與」

### 策略 6：會員專屬內容 - 深化核心粉絲關係
- 評估是否適合開啟「頻道會員」功能
- 提供會員專屬福利（例如：提前觀看、幕後花絮、專屬 Q&A）
- 成效：核心粉絲願意付費支持，建立更強連結

**輸出格式要求：**

## 👥 核心觀眾畫像
（詳細描述主要觀眾群體：年齡、性別、地理位置、設備偏好、行為特徵）

## 📱 觀眾行為洞察
（觀眾如何發現和觀看內容、流量來源分析、互動模式分析）

## 💬 互動模式與內容偏好
（高互動內容特徵、觀眾參與意願評估、內容偏好差異）

## 🔗 觀眾黏性間接評估
（發片節奏穩定性、觀看數穩定性、訂閱者活躍度推論）

## 🎯 內容定位建議
（針對核心觀眾群體的內容主題、格式、風格建議）

## 🚀 觀眾黏性提升策略（6 大方向）
1. 固定發片節奏：具體時間規劃
2. 系列化內容：季播節目企劃
3. 社群互動：留言區經營策略
4. 播放列表優化：組織架構建議
5. 觀眾參與機制：互動式內容設計
6. 會員專屬內容：深化粉絲關係

**撰寫規範：**
- 使用台灣繁體中文
- 基於數據提供洞察，明確標註推論部分
- 每個建議都要針對具體的觀眾群體並提供執行範例
- 中文、英文、數字之間加上半形空格
`;
  }

  /**
   * 綜合分析提示詞
   * 核心：增長飛輪模型、總觀看時長作為北極星指標、頻道健康度診斷
   */
  static buildComprehensivePrompt(baseContext, data) {
    return `**分析角色：** YouTube 頻道的首席內容策略官

**核心框架：** 基於「增長飛輪」模型，以「總觀看時長」為北極星指標

${baseContext}

**YouTube 增長飛輪運作機制**
良性循環（飛輪加速）：
1. 高品質內容 →
2. 高觀看時長（觀眾滿意） →
3. 演算法判定為優質內容 →
4. 增加曝光與推薦 →
5. 吸引更多新觀眾 →
6. 新觀眾也貢獻高觀看時長 →
7. 訂閱增長 →
8. 回到步驟 1，飛輪轉速加快

惡性循環（飛輪停滯）：
1. 低品質內容 →
2. 低觀看時長（觀眾快速離開） →
3. 演算法判定為劣質內容 →
4. 停止推薦 →
5. 曝光銳減 →
6. 觀看停滯 →
7. 訂閱停滯 →
8. 飛輪卡死

**⚠️ 分析限制與策略**
由於 YouTube API 限制，無法直接取得：CTR、曝光次數、詳細續看率
將透過「觀看數、互動率、流量來源、訂閱增長」等可用指標，診斷飛輪運轉狀態

**核心分析任務：**

## 1. 頻道健康度總覽：增長飛輪診斷
- **飛輪運轉狀態評估：**
  * 觀看次數趨勢（增長？停滯？下降？）
  * 訂閱者增長趨勢
  * 內容產出節奏（發片頻率是否穩定？）
  * **診斷：** 飛輪處於哪個階段？
    - ✅ 加速期（觀看 ↑、訂閱 ↑、互動 ↑）
    - ⚠️ 平台期（指標平穩但未增長）
    - 🚨 衰退期（指標下降）
    - 💀 停滯期（長時間無明顯變化）

- **內容效率健康度：**
  * 計算「訂閱者 / 影片比」（見基礎數據）
  * 對比業界標竿：
    - Joeman：809（2.75M 訂閱 / 3.4K 影片）
    - 電腦王阿達：180（17.1 萬 / 951 影片）
    - PChome 24h：64（6.07 萬 / 955 影片）
  * **診斷：** 頻道的內容效率是否健康？還是陷入「內容黑洞」？

- **流量來源健康度：**
  * 推薦流量（Suggested）佔比 > 40% = 健康
  * 搜尋流量（Search）佔比 30-40% = 良好
  * 外部流量（External）佔比 > 50% = 警訊（過度依賴外部導流）

## 2. 內容主題分析與資源配置
- **主題識別與分類：**
  * 根據影片標題和標籤，識別頻道的主要內容支柱
  * 計算各主題的影片數量、平均觀看數、平均互動率

- **內容支柱表現對比：**
  * 識別「明星支柱」（高觀看 + 高互動）
  * 識別「黑洞支柱」（低觀看 + 低互動）
  * 計算各支柱的資源佔比 vs 產出效益

- **資源配置診斷：**
  * 頻道是否將大量資源投入低效支柱？
  * 是否忽略了高潛力但投入不足的支柱？

## 3. 策略診斷：識別內容磁鐵與低效內容
- **內容磁鐵識別（Top 10）：**
  * 找出「訂閱磁鐵」（高觀看 + 高互動，推測帶來大量訂閱）
  * 找出「觀看磁鐵」（極高觀看數，成功吸引新觀眾）
  * 分析這些影片的共同特徵：
    - 內容主題（評測？教學？娛樂？）
    - 標題結構（SEO 優化？吸引力法則？）
    - 內容深度（長影片？短影片？）
    - 發布時間模式

- **低效內容識別（Bottom 20%）：**
  * 找出「高產量、低效率」的內容類型
  * 診斷原因：
    - SEO 不足（好內容但沒人看到）
    - 內容品質問題（觀眾看了但不滿意）
    - 定位錯誤（不符合頻道觀眾期待）

- **策略評估：**
  * 頻道的內容定位是否清晰？
  * 是否過度分散（同時做太多不相關主題）？
  * 系列化程度如何？

## 4. 競品標竿對比與差距分析
- 基於頻道定位，選擇 2-3 個競品進行對比：
  * 內容效率對比（訂閱者/影片比）
  * 內容類型對比（深度評測 vs 速報精華）
  * 更新頻率對比
  * 內容差異化分析

- **差距診斷：**
  * 頻道落後競品的主要原因？
  * 頻道的獨特優勢是什麼？（如何放大？）

## 5. 增長飛輪卡點診斷與突破策略
基於以上分析，診斷飛輪「卡在哪個環節」：

- **卡點 1：內容品質不足**
  * 症狀：互動率低、觀看時長短
  * 突破：提升內容深度、強化腳本策劃

- **卡點 2：SEO 曝光不足**
  * 症狀：搜尋流量低、高品質內容沒人看到
  * 突破：標題/標籤優化、關鍵字研究

- **卡點 3：演算法推薦不足**
  * 症狀：推薦流量低、過度依賴外部導流
  * 突破：優化觀看時長、提升互動率、建立系列內容

- **卡點 4：訂閱轉換不足**
  * 症狀：觀看高但訂閱低
  * 突破：系列化內容、CTA 優化、建立觀眾期待

- **卡點 5：內容效率低落**
  * 症狀：高產量但訂閱增長緩慢
  * 突破：停止低效內容、集中資源於高效主題

## 6. 長期戰略規劃：3 個月 vs 6 個月 vs 12 個月
- **3 個月短期目標：**
  * 立即停止低效內容
  * 全面 SEO 優化
  * 建立固定發片節奏

- **6 個月中期目標：**
  * 啟動 2-3 個系列節目
  * 內容效率提升 50%
  * 推薦流量佔比提升至 40%

- **12 個月長期願景：**
  * 成為特定領域的權威頻道
  * 訂閱者/影片比達到業界標竿水準
  * 增長飛輪進入自驅動階段

**輸出格式要求：**

## 📊 頻道健康度總覽：增長飛輪診斷
（飛輪運轉狀態、內容效率健康度、流量來源健康度、整體評分）

## 🎯 內容主題分析與資源配置
（各主題表現、資源配置診斷、優化建議）

## 🔍 內容磁鐵 vs 低效內容識別
（Top 10 高效影片分析、Bottom 20% 低效內容診斷、成功因素提煉）

## 📈 競品標竿對比
（選定競品、多維度對比、差距分析、差異化機會）

## 💡 增長飛輪卡點診斷
（診斷卡在哪個環節、根因分析、突破策略）

## 🚀 關鍵行動項目（優先順序排序）
**立即執行（本週內）：**
1. ...
2. ...

**短期優化（3 個月內）：**
1. ...
2. ...

**中期轉型（6 個月內）：**
1. ...
2. ...

**長期願景（12 個月）：**
- 目標訂閱者數：...
- 目標內容效率：...
- 目標流量結構：...

## 📋 最終建議：頻道定位與轉型方向
（頻道應該成為什麼？核心價值主張是什麼？與競品的差異化是什麼？）

**撰寫規範：**
- 使用台灣繁體中文
- 提供可量化的目標和時間表
- 每個建議都有具體執行步驟和預期成效
- 中文、英文、數字之間加上半形空格
- 必須有明確的優先順序（什麼該先做、什麼可以後做）
`;
  }

  /**
   * 關鍵字分析提示詞
   * 核心：關鍵字效能評估、YouTube SEO 優化、內容主題布局策略
   */
  static buildKeywordAnalysisPrompt(data) {
    const { keywordGroups, dateColumns, analyticsData, selectedMetrics } = data;

    // 建立關鍵字數據表格
    let keywordDataTable = `\n**關鍵字組合效能數據：**\n\n`;
    keywordDataTable += `| 關鍵字組合 | ${dateColumns.map(col => col.label).join(' | ')} |\n`;
    keywordDataTable += `|${'-'.repeat(15)}|${dateColumns.map(() => '-'.repeat(15)).join('|')}|\n`;

    keywordGroups.forEach((group) => {
      const row = [group.name];
      dateColumns.forEach((col) => {
        const cellData = analyticsData[group.id]?.[col.id];
        if (cellData && !cellData.error) {
          const metrics = selectedMetrics.map((metric) => {
            const metricData = AVAILABLE_METRICS.find(m => m.key === metric);
            const value = cellData[metric];
            if (value === undefined || value === null) return null;

            let formattedValue = value.toLocaleString();
            if (metricData.format === 'percentage') {
              formattedValue = `${value.toFixed(1)}%`;
            } else if (metricData.format === 'duration') {
              formattedValue = `${value.toFixed(0)}s`;
            }
            return `${metricData.label}: ${formattedValue}`;
          }).filter(Boolean).join(', ');
          row.push(metrics || '無數據');
        } else {
          row.push(cellData?.error || '無數據');
        }
      });
      keywordDataTable += `| ${row.join(' | ')} |\n`;
    });

    // 計算整體指標
    let totalStats = {
      totalViews: 0,
      totalLikes: 0,
      totalComments: 0,
      totalVideos: 0,
      avgEngagement: 0,
    };

    Object.values(analyticsData).forEach((groupData) => {
      Object.values(groupData).forEach((cellData) => {
        if (cellData && !cellData.error) {
          totalStats.totalViews += cellData.views || 0;
          totalStats.totalLikes += cellData.likes || 0;
          totalStats.totalComments += cellData.comments || 0;
          totalStats.totalVideos += cellData.videoCount || 0;
        }
      });
    });

    if (totalStats.totalViews > 0) {
      totalStats.avgEngagement = ((totalStats.totalLikes + totalStats.totalComments) / totalStats.totalViews * 100);
    }

    return `**分析角色：** YouTube 關鍵字策略專家 & SEO 優化顧問

**核心使命：** 診斷關鍵字效能，識別高價值關鍵字，提供 YouTube SEO 優化策略與內容布局建議

**YouTube 關鍵字策略核心原理**
YouTube 搜尋演算法的核心是「相關性 + 參與度 + 觀看時長」。成功的關鍵字策略需要：
1. **高搜尋量關鍵字**：帶來大量曝光機會
2. **高相關性**：符合頻道定位，吸引目標觀眾
3. **中低競爭度**：避開紅海，找到藍海機會
4. **長尾關鍵字**：精準觸及有明確需求的觀眾
5. **系列化布局**：透過主題群組建立頻道權威

${keywordDataTable}

**整體效能指標：**
- 總觀看次數：${totalStats.totalViews.toLocaleString()}
- 總按讚數：${totalStats.totalLikes.toLocaleString()}
- 總留言數：${totalStats.totalComments.toLocaleString()}
- 影片總數：${totalStats.totalVideos}
- **平均互動率：${totalStats.avgEngagement.toFixed(2)}%**（按讚 + 留言 / 觀看）

**分析期間比較：**
- 日期範圍：${dateColumns.map(col => col.label).join(' vs ')}
- 關鍵字組合數：${keywordGroups.length} 個

**⚠️ 分析策略與限制**
- YouTube API 提供的數據為「已發布影片」在「特定時間範圍內」的實際觀看表現
- 無法取得：關鍵字搜尋量、競爭度、CTR
- 可用代理指標：
  1. **觀看數** → 代理搜尋量和曝光力
  2. **互動率（按讚率 + 留言率）** → 代理內容相關性和觀眾滿意度
  3. **影片數量** → 代理內容覆蓋度
  4. **時間序列對比** → 識別增長 vs 衰退的關鍵字

**核心分析任務：**

## 1. 關鍵字效能診斷（4 象限分類）

基於「觀看數」和「互動率」，將所有關鍵字組合分類為 4 個象限：

- **明星關鍵字**（高觀看 + 高互動）：
  * 特徵：既有流量又有滿意度，是頻道的核心價值來源
  * 策略：加倍投入，製作系列內容深化此主題
  * 識別：哪些關鍵字落在此象限？

- **潛力關鍵字**（低觀看 + 高互動）：
  * 特徵：觀眾滿意度高但曝光不足，可能是 SEO 優化問題
  * 策略：優化標題/標籤，提升搜尋可見度
  * 識別：哪些關鍵字落在此象限？

- **流量關鍵字**（高觀看 + 低互動）：
  * 特徵：吸引點擊但內容不符期待，可能是點擊誘餌或內容品質問題
  * 策略：提升內容深度和價值，或調整標題更符合實際內容
  * 識別：哪些關鍵字落在此象限？

- **低效關鍵字**（低觀看 + 低互動）：
  * 特徵：既無流量也無滿意度，可能是紅海主題或定位錯誤
  * 策略：停止投入，或重新包裝定位
  * 識別：哪些關鍵字落在此象限？

## 2. 時間序列趨勢分析

對比不同時間範圍的數據，識別：
- **增長中的關鍵字**（新時期觀看數 > 舊時期觀看數）：
  * 意義：市場需求上升，或頻道在此主題的權威性提升
  * 行動：乘勝追擊，加速產出相關內容

- **衰退中的關鍵字**（新時期觀看數 < 舊時期觀看數）：
  * 意義：市場需求下降，或競爭加劇，或內容過時
  * 行動：診斷原因，決定是優化還是放棄

- **穩定的關鍵字**（觀看數變化不大）：
  * 意義：常青樹主題，或已達該主題的市場天花板
  * 行動：維持現有產出節奏，關注競品動態

## 3. 關鍵字覆蓋度與內容缺口

- **覆蓋度評估：**
  * 各關鍵字組合的影片數量是否均衡？
  * 是否過度集中在某一主題，忽略其他潛力主題？

- **內容缺口識別：**
  * 基於現有關鍵字，還缺少哪些相關的子主題或延伸主題？
  * 例如：若有「AI 應用」，是否缺少「AI 繪圖教學」、「AI 影片剪輯」等細分主題？

- **長尾關鍵字機會：**
  * 建議 5-10 個「長尾關鍵字」（問句形式、特定場景）
  * 例如：「如何用 ChatGPT 寫行銷文案」、「Midjourney 新手常見問題」

## 4. YouTube SEO 優化策略

基於關鍵字數據，提供具體的 SEO 優化建議：

### 標題優化
- **關鍵字前置原則：** 將「明星關鍵字」放在標題前半部
- **吸引力法則：** 結合數字、問句、實用性
- **範例：** 針對表現最好的 3 個關鍵字，提供標題優化範例

### 標籤策略
- **主要標籤：** 使用「明星關鍵字」作為核心標籤
- **次要標籤：** 加入「潛力關鍵字」和相關延伸詞
- **長尾標籤：** 加入問句式長尾關鍵字
- **範例：** 提供一組完整的標籤建議（15-20 個）

### 描述優化
- 前 80 字必須包含核心關鍵字
- 加入時間戳記（章節標題中嵌入關鍵字）
- 在描述中自然重複關鍵字 2-3 次（避免關鍵字堆砌）

## 5. 內容布局策略建議

- **明星關鍵字深化：**
  * 將「明星關鍵字」發展為系列節目（例如：每週一集，共 12 集）
  * 提供具體的系列規劃範例

- **潛力關鍵字激活：**
  * 優化現有影片的標題和標籤
  * 製作「深度版」或「進階版」內容以提升價值

- **新主題探索：**
  * 基於內容缺口分析，建議 3-5 個新的關鍵字主題
  * 評估各主題的機會度（搜尋潛力、競爭度、與頻道的契合度）

- **內容發布節奏：**
  * 建議各關鍵字主題的內容佔比（例如：明星主題 50%、潛力主題 30%、新主題 20%）
  * 提供 3 個月的內容日曆範例

## 6. 競品關鍵字分析（選填）

若有明確的競品頻道，建議分析：
- 競品在相同關鍵字上的表現
- 競品使用但本頻道尚未覆蓋的關鍵字
- 差異化關鍵字策略（避開紅海，找藍海）

**輸出格式要求：**

## 📊 關鍵字效能診斷（4 象限分類）
（將每個關鍵字組合分類到明星/潛力/流量/低效象限，說明特徵和策略）

## 📈 時間序列趨勢分析
（識別增長中、衰退中、穩定的關鍵字，提供具體行動建議）

## 💡 內容缺口與長尾關鍵字機會
（列出缺少的子主題、建議 5-10 個長尾關鍵字）

## 🔍 YouTube SEO 優化策略
（標題優化範例、標籤策略、描述優化建議）

## 🎯 內容布局策略
（明星關鍵字系列規劃、潛力關鍵字激活、新主題探索、內容佔比建議）

## 🚀 關鍵行動計畫（優先順序排序）
**立即執行（本週內）：**
1. ...
2. ...

**短期優化（1 個月內）：**
1. ...
2. ...

**中期布局（3 個月內）：**
1. ...
2. ...

## 📋 3 個月內容日曆範例
（提供具體的內容排程建議，含關鍵字主題、建議標題、發布頻率）

**撰寫規範：**
- 使用台灣繁體中文
- 提供可量化的目標（例如：3 個月內將明星關鍵字的觀看數提升 30%）
- 每個建議都有具體執行步驟和範例
- 中文、英文、數字之間加上半形空格
- 必須基於實際數據進行分析，避免空泛建議
`;
  }
}

// 輔助常數（用於關鍵字分析）
const AVAILABLE_METRICS = [
  { key: 'views', label: '觀看次數', format: 'number' },
  { key: 'estimatedMinutesWatched', label: '觀看時長', format: 'number' },
  { key: 'averageViewDuration', label: '平均觀看時長', format: 'duration' },
  { key: 'averageViewPercentage', label: '平均觀看百分比', format: 'percentage' },
  { key: 'likes', label: '按讚數', format: 'number' },
  { key: 'comments', label: '留言數', format: 'number' },
  { key: 'shares', label: '分享數', format: 'number' },
  { key: 'subscribersGained', label: '新增訂閱', format: 'number' },
  { key: 'videoCount', label: '影片數', format: 'number' },
];

# 手機端異步任務解決方案

## 問題描述

當在手機瀏覽器上使用時，如果切換分頁或應用進入背景，長時間運行的請求會被中斷，導致內容生成失敗。

## 解決方案

實現了**異步任務隊列系統**，將長時間運行的操作轉換為背景任務，前端使用輪詢機制查詢進度。

## 架構說明

### 後端

1. **任務隊列系統** (`services/taskQueue.js`)
   - 內存版本的任務管理系統
   - 支持任務創建、進度更新、狀態查詢
   - 自動清理完成的任務（30分鐘後）

2. **異步 API 端點** (`server.js`)
   - `POST /api/generate-article-url-async` - 創建文章生成任務
   - `POST /api/analyze-video-url-async` - 創建中繼資料生成任務
   - `GET /api/task/:taskId` - 查詢任務狀態
   - `DELETE /api/task/:taskId` - 取消任務

### 前端

1. **任務輪詢服務** (`services/taskPollingService.ts`)
   - 輪詢任務狀態直到完成
   - 支持進度回調
   - 處理超時和錯誤

2. **異步 API 函數** (`services/videoApiService.ts`)
   - `generateArticleWithYouTubeUrlAsync()` - 異步版本的文章生成函數
   - `analyzePublicVideoAsync()` - 異步版本的中繼資料生成函數
   - 自動處理任務創建和輪詢

3. **異步 Gemini 服務** (`services/geminiService.ts`)
   - `generateVideoMetadataAsync()` - 異步版本的影片中繼資料生成
   - 支持公開影片（異步）和未列出影片（同步降級）

## 使用方式

### 對於用戶

**無需改變使用習慣！**系統已自動切換到異步模式。

現在你可以：
- ✅ 在生成內容時切換分頁
- ✅ 讓應用進入背景
- ✅ 鎖定手機螢幕
- ✅ 任務會在背景繼續執行

### 異步支持功能列表

✅ **已支持異步**：
- 文章生成（公開影片）
- 中繼資料生成（標題、描述、標籤 - 公開影片）

⚠️ **部分支持**：
- 未列出影片中繼資料生成（使用同步降級）

❌ **尚未支持**：
- 未列出影片文章生成
- 截圖生成

### 對於開發者

#### 1. 測試異步任務

```bash
# 啟動伺服器
npm run server

# 在另一個終端啟動前端
npm run dev
```

#### 2. 測試場景

1. **正常流程測試**
   - 選擇一個公開的 YouTube 影片
   - 點擊「生成文章」
   - 觀察進度更新
   - 等待完成

2. **手機端測試（重點！）**

   **測試場景 A - 生成文章**：
   - 在手機上打開應用
   - 選擇一個公開影片
   - 點擊「生成文章」
   - **立即切換到其他應用** 👈 重點測試
   - 等待 2-3 分鐘後切換回來
   - 檢查是否正常完成

   **測試場景 B - 生成中繼資料**：
   - 在手機上打開應用
   - 選擇一個公開影片
   - 點擊「Generate with AI」生成標題描述標籤
   - **立即鎖定手機螢幕** 👈 重點測試
   - 等待 1-2 分鐘後解鎖
   - 檢查是否正常完成

3. **背景執行測試**
   - 開始生成文章
   - 立即關閉瀏覽器分頁
   - 等待 2-3 分鐘
   - 重新打開應用
   - 任務仍在背景執行

#### 3. 監控任務狀態

使用瀏覽器開發者工具查看：

```javascript
// 在 Console 中查看任務狀態
fetch('http://localhost:3001/api/task/YOUR_TASK_ID')
  .then(r => r.json())
  .then(console.log)
```

## 技術細節

### 任務生命週期

```
1. 創建任務 (pending)
   ↓
2. 開始執行 (processing)
   ↓
3. 進度更新 (processing, progress: 0-100%)
   ↓
4. 完成或失敗 (completed/failed)
   ↓
5. 自動清理 (30分鐘後)
```

### 輪詢機制

- **輪詢間隔**: 2 秒
- **超時時間**: 10 分鐘
- **自動重試**: 是（在錯誤時）

### 性能考量

1. **內存使用**
   - 任務數據存儲在內存中
   - 已完成任務會在 30 分鐘後自動清理
   - 適合中小規模應用

2. **擴展性**
   - 如需支持更大規模，可以替換為 Redis 或數據庫
   - 當前實現已預留擴展接口

## 優點

1. ✅ **手機友好** - 不怕切換分頁或進入背景
2. ✅ **超時保護** - 不受 Render 30 秒限制影響
3. ✅ **進度可見** - 實時顯示任務進度
4. ✅ **錯誤處理** - 完善的錯誤處理和重試機制
5. ✅ **無縫切換** - 保留原有同步 API，向後兼容

## 限制

1. ⚠️ **任務持久性** - 伺服器重啟會丟失進行中的任務
2. ⚠️ **單機限制** - 不支持多實例部署（可通過 Redis 解決）
3. ⚠️ **內存限制** - 大量並發任務會增加內存使用

## 未來改進

1. 🔄 **持久化存儲** - 使用 Redis 或數據庫存儲任務狀態
2. 🔄 **WebSocket 通知** - 替代輪詢，實時推送進度
3. 🔄 **任務隊列** - 限制並發數量，避免資源耗盡
4. 🔄 **任務歷史** - 保存已完成任務的歷史記錄

## 故障排除

### 問題：任務一直是 pending 狀態

**原因**：後端可能崩潰或任務執行器未啟動

**解決**：
```bash
# 檢查伺服器日誌
npm run server

# 查看是否有錯誤訊息
```

### 問題：任務找不到 (404)

**原因**：任務已被清理或 taskId 錯誤

**解決**：
- 確認 taskId 正確
- 檢查任務是否已完成超過 30 分鐘

### 問題：輪詢超時

**原因**：任務執行時間超過 10 分鐘

**解決**：
- 增加 `timeout` 參數
- 檢查任務是否卡住

## 部署到 Render

1. 確保環境變數設定正確
2. 異步任務系統會自動啟用
3. 注意內存限制（免費方案 512MB）

## 相關文件

### 後端
- `services/taskQueue.js` - 任務隊列系統
- `server.js` - 異步 API 端點

### 前端服務層
- `services/taskPollingService.ts` - 任務輪詢服務
- `services/videoApiService.ts` - 異步 API 函數
- `services/geminiService.ts` - 異步 Gemini 服務

### 前端組件
- `components/ArticleGenerator.tsx` - 文章生成組件
- `components/MetadataGenerator.tsx` - 中繼資料生成組件

### 文檔與測試
- `ASYNC_TASK_SOLUTION.md` - 技術文檔（本文件）
- `test-async-task.html` - 測試工具

## 聯繫與支援

如有問題，請查看：
1. 伺服器日誌
2. 瀏覽器 Console
3. Network 請求詳情

---

**注意**：此解決方案已在開發環境測試，建議在生產環境部署前進行完整測試。

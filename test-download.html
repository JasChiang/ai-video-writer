<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‹è¼‰åŠŸèƒ½æ¸¬è©¦å·¥å…·</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #dc2626;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #dc2626;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-right: 10px;
        }
        button:hover {
            background: #b91c1c;
        }
        button.secondary {
            background: #6b7280;
        }
        button.secondary:hover {
            background: #4b5563;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .stat-box {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #dc2626;
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #dc2626;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ä¸‹è¼‰åŠŸèƒ½æ¸¬è©¦å·¥å…·</h1>
        <p class="subtitle">æ¸¬è©¦ OAuth tokenã€é€Ÿç‡é™åˆ¶å’Œå¸³è™Ÿåˆ‡æ›åŠŸèƒ½</p>

        <!-- çµ±è¨ˆè³‡è¨Š -->
        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="successCount">0</div>
                <div class="stat-label">æˆåŠŸæ¬¡æ•¸</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="failCount">0</div>
                <div class="stat-label">å¤±æ•—æ¬¡æ•¸</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="rateLimitCount">0</div>
                <div class="stat-label">é€Ÿç‡é™åˆ¶è§¸ç™¼</div>
            </div>
        </div>

        <!-- æ¸¬è©¦ 1: å–®æ¬¡ä¸‹è¼‰ -->
        <div class="test-section">
            <h3>ğŸ“¤ æ¸¬è©¦ 1: å–®æ¬¡ä¸‹è¼‰è«‹æ±‚</h3>
            <label>ä¼ºæœå™¨ URL:</label>
            <input type="text" id="serverUrl" value="http://localhost:3001" placeholder="http://localhost:3001">

            <label>å½±ç‰‡ ID:</label>
            <input type="text" id="videoId" value="dQw4w9WgXcQ" placeholder="dQw4w9WgXcQ">

            <label>Access Token (é¸å¡«):</label>
            <input type="text" id="accessToken" placeholder="ç•™ç©ºè¡¨ç¤ºæœªç™»å…¥">

            <button onclick="testSingleDownload()">ğŸš€ ç™¼é€è«‹æ±‚</button>
            <button class="secondary" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>

            <div id="singleResult"></div>
        </div>

        <!-- æ¸¬è©¦ 2: æ‰¹é‡æ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ”„ æ¸¬è©¦ 2: æ‰¹é‡æ¸¬è©¦ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰</h3>
            <label>è«‹æ±‚æ¬¡æ•¸:</label>
            <input type="number" id="batchCount" value="12" min="1" max="30">

            <label>é–“éš”æ™‚é–“ï¼ˆç§’ï¼‰:</label>
            <input type="number" id="batchDelay" value="1" min="0" max="10" step="0.5">

            <button onclick="testBatchDownload()">ğŸ”„ é–‹å§‹æ‰¹é‡æ¸¬è©¦</button>
            <button class="secondary" onclick="stopBatchTest()" id="stopBtn" disabled>â¹ï¸ åœæ­¢</button>

            <div id="batchResult"></div>
        </div>

        <!-- æ¸¬è©¦ 3: æª¢æŸ¥å‰©é¤˜é¡åº¦ -->
        <div class="test-section">
            <h3>ğŸ“Š æ¸¬è©¦ 3: æª¢æŸ¥å‰©é¤˜é¡åº¦</h3>
            <p>ç™¼é€ä¸€æ¬¡è«‹æ±‚ä¾†æŸ¥çœ‹ç•¶å‰å‰©é¤˜é¡åº¦</p>
            <button onclick="checkRemainingQuota()">ğŸ” æª¢æŸ¥é¡åº¦</button>

            <div id="quotaResult"></div>
        </div>
    </div>

    <script>
        let successCount = 0;
        let failCount = 0;
        let rateLimitCount = 0;
        let stopBatch = false;

        function updateStats() {
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('failCount').textContent = failCount;
            document.getElementById('rateLimitCount').textContent = rateLimitCount;
        }

        function clearResults() {
            document.getElementById('singleResult').innerHTML = '';
            document.getElementById('batchResult').innerHTML = '';
            document.getElementById('quotaResult').innerHTML = '';
        }

        async function testSingleDownload() {
            const serverUrl = document.getElementById('serverUrl').value;
            const videoId = document.getElementById('videoId').value;
            const accessToken = document.getElementById('accessToken').value;
            const resultDiv = document.getElementById('singleResult');

            resultDiv.innerHTML = '<div class="result info">â³ ç™¼é€è«‹æ±‚ä¸­...</div>';

            try {
                const response = await fetch(`${serverUrl}/api/download-video`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        videoId: videoId,
                        accessToken: accessToken || undefined,
                    }),
                });

                const data = await response.json();
                const timestamp = new Date().toLocaleTimeString('zh-TW');

                if (response.ok) {
                    successCount++;
                    updateStats();
                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… æˆåŠŸ (${response.status}) - ${timestamp}
                            ${JSON.stringify(data, null, 2)}
                        </div>
                    `;
                } else if (response.status === 429) {
                    rateLimitCount++;
                    updateStats();
                    resultDiv.innerHTML = `
                        <div class="result error">
                            âš ï¸ é€Ÿç‡é™åˆ¶è§¸ç™¼ (${response.status}) - ${timestamp}
                            è¨Šæ¯: ${data.message}
                            ç­‰å¾…æ™‚é–“: ${data.waitMinutes} åˆ†é˜
                            é™åˆ¶é¡å‹: ${data.limitType}
                        </div>
                    `;
                } else {
                    failCount++;
                    updateStats();
                    resultDiv.innerHTML = `
                        <div class="result error">
                            âŒ å¤±æ•— (${response.status}) - ${timestamp}
                            ${JSON.stringify(data, null, 2)}
                        </div>
                    `;
                }
            } catch (error) {
                failCount++;
                updateStats();
                resultDiv.innerHTML = `
                    <div class="result error">
                        âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}
                    </div>
                `;
            }
        }

        async function testBatchDownload() {
            const count = parseInt(document.getElementById('batchCount').value);
            const delay = parseFloat(document.getElementById('batchDelay').value) * 1000;
            const serverUrl = document.getElementById('serverUrl').value;
            const videoId = document.getElementById('videoId').value;
            const accessToken = document.getElementById('accessToken').value;
            const resultDiv = document.getElementById('batchResult');

            stopBatch = false;
            document.getElementById('stopBtn').disabled = false;

            resultDiv.innerHTML = '<div class="result info">ğŸ”„ é–‹å§‹æ‰¹é‡æ¸¬è©¦...</div>';

            for (let i = 1; i <= count; i++) {
                if (stopBatch) {
                    resultDiv.innerHTML += `\nâ¹ï¸ æ¸¬è©¦å·²åœæ­¢æ–¼ç¬¬ ${i-1} æ¬¡è«‹æ±‚`;
                    break;
                }

                try {
                    const response = await fetch(`${serverUrl}/api/download-video`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            videoId: videoId,
                            accessToken: accessToken || undefined,
                        }),
                    });

                    const data = await response.json();
                    const timestamp = new Date().toLocaleTimeString('zh-TW');
                    let emoji = '';
                    let className = '';

                    if (response.ok) {
                        successCount++;
                        emoji = 'âœ…';
                        className = 'success';
                    } else if (response.status === 429) {
                        rateLimitCount++;
                        emoji = 'âš ï¸';
                        className = 'error';
                        resultDiv.innerHTML = `
                            <div class="result ${className}">
                                æ‰¹é‡æ¸¬è©¦çµæœ (å…± ${i} æ¬¡è«‹æ±‚):
                                ${emoji} ç¬¬ ${i} æ¬¡: HTTP ${response.status} - ${timestamp}
                                âš ï¸ é€Ÿç‡é™åˆ¶è§¸ç™¼ï¼
                                è¨Šæ¯: ${data.message}
                                é™åˆ¶é¡å‹: ${data.limitType}

                                ğŸ“Š çµ±è¨ˆ:
                                - æˆåŠŸ: ${successCount}
                                - å¤±æ•—: ${failCount}
                                - é€Ÿç‡é™åˆ¶: ${rateLimitCount}
                            </div>
                        `;
                        updateStats();
                        break;
                    } else {
                        failCount++;
                        emoji = 'âŒ';
                        className = 'error';
                    }

                    updateStats();

                    resultDiv.innerHTML = `
                        <div class="result ${className}">
                            æ‰¹é‡æ¸¬è©¦é€²åº¦: ${i} / ${count}
                            ${emoji} ç¬¬ ${i} æ¬¡: HTTP ${response.status} - ${timestamp}

                            ğŸ“Š ç›®å‰çµ±è¨ˆ:
                            - æˆåŠŸ: ${successCount}
                            - å¤±æ•—: ${failCount}
                            - é€Ÿç‡é™åˆ¶: ${rateLimitCount}
                        </div>
                    `;

                    if (i < count) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                } catch (error) {
                    failCount++;
                    updateStats();
                    resultDiv.innerHTML += `\nâŒ ç¬¬ ${i} æ¬¡å¤±æ•—: ${error.message}`;
                }
            }

            document.getElementById('stopBtn').disabled = true;
        }

        function stopBatchTest() {
            stopBatch = true;
            document.getElementById('stopBtn').disabled = true;
        }

        async function checkRemainingQuota() {
            const serverUrl = document.getElementById('serverUrl').value;
            const videoId = document.getElementById('videoId').value;
            const accessToken = document.getElementById('accessToken').value;
            const resultDiv = document.getElementById('quotaResult');

            resultDiv.innerHTML = '<div class="result info">ğŸ” æª¢æŸ¥é¡åº¦ä¸­...</div>';

            try {
                const response = await fetch(`${serverUrl}/api/download-video`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        videoId: videoId,
                        accessToken: accessToken || undefined,
                    }),
                });

                const data = await response.json();

                if (response.status === 429) {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            âš ï¸ å·²é”é€Ÿç‡é™åˆ¶
                            è¨Šæ¯: ${data.message}
                            ç­‰å¾…æ™‚é–“: ${data.waitMinutes} åˆ†é˜
                            é™åˆ¶é¡å‹: ${data.limitType}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… é¡åº¦æª¢æŸ¥å®Œæˆ
                            ç‹€æ…‹: å¯ä»¥ç¹¼çºŒä½¿ç”¨

                            ğŸ’¡ æç¤º: æŸ¥çœ‹ä¼ºæœå™¨æ—¥èªŒä»¥äº†è§£å‰©é¤˜æ¬¡æ•¸
                            ä¾‹å¦‚: "Token: X remaining, IP: Y remaining"
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        âŒ éŒ¯èª¤: ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>

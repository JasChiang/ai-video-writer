version: '3.8'

services:
  ai-video-writer:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: ai-video-writer
    ports:
      - "3001:3001"
    environment:
      # ==================== 核心設定 ====================
      - NODE_ENV=production
      - PORT=3001

      # ==================== 必填環境變數 ====================
      # ⚠️  這些變數必須設定，否則應用程式無法運作
      # 方式 1: 在 .env.local 中設定 (開發環境)
      # 方式 2: 在 Docker Desktop 中手動設定
      # 方式 3: 在部署平台設定 (生產環境)
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - YOUTUBE_CLIENT_ID=${YOUTUBE_CLIENT_ID:-}

      # ==================== 網路設定 ====================
      # 前端網址（用於 CORS 和 Notion OAuth）
      # 開發環境: http://localhost:3000
      # 生產環境: https://your-domain.com
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}

      # 前端 API 和伺服器基址（僅在特殊配置時需要）
      - VITE_API_URL=${VITE_API_URL:-}
      - VITE_SERVER_BASE_URL=${VITE_SERVER_BASE_URL:-}

      # ==================== 檔案管理 ====================
      # 暫存檔案保留天數（啟動時自動清理）
      - FILE_RETENTION_DAYS=${FILE_RETENTION_DAYS:-7}

      # ==================== Notion 整合 (可選) ====================
      # Internal Integration
      - NOTION_API_TOKEN=${NOTION_API_TOKEN:-}
      - NOTION_DATABASE_ID=${NOTION_DATABASE_ID:-}
      - NOTION_TITLE_PROPERTY=${NOTION_TITLE_PROPERTY:-Name}

      # Public Integration (OAuth)
      - NOTION_CLIENT_ID=${NOTION_CLIENT_ID:-}
      - NOTION_CLIENT_SECRET=${NOTION_CLIENT_SECRET:-}
      - NOTION_REDIRECT_URI=${NOTION_REDIRECT_URI:-}

    volumes:
      # 持久化暫存影片
      - ./temp_videos:/app/temp_videos
      # 持久化截圖
      - ./public/images:/app/public/images
      # 持久化上傳的參考檔案
      - ./temp_files:/app/temp_files

    restart: unless-stopped

    # Health check (已在 Dockerfile 中定義，這裡保留作為參考)
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/app-config.js', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # 安全設定（可選，增強安全性）
    # security_opt:
    #   - no-new-privileges:true
    # cap_drop:
    #   - ALL
    # read_only: true
    # tmpfs:
    #   - /tmp

    # 資源限制（可選，防止資源耗盡）
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 2G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 512M

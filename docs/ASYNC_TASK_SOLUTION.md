# 異步任務系統：解決長時間操作中斷問題

本文件詳細說明 AI Video Writer 中實現的異步任務系統，旨在解決手機瀏覽器或背景執行時，長時間操作（如內容生成）可能被中斷的問題。

## 💡 問題背景

在手機瀏覽器上，當用戶切換應用程式、分頁或鎖定螢幕時，正在進行的長時間 HTTP 請求可能會被作業系統中斷。這導致 AI 內容生成等耗時操作失敗，影響用戶體驗。

## ✅ 解決方案：異步任務隊列系統

我們實現了一個異步任務隊列系統，將耗時的操作轉換為後端背景任務。前端則透過輪詢機制查詢任務進度，確保即使前端中斷，後端任務也能持續完成。

## ⚙️ 架構概覽

### 後端

-   **任務隊列管理 (`services/taskQueue.js`)**：
    -   一個基於內存的任務管理系統，負責任務的創建、狀態更新和進度追蹤。
    -   自動清理已完成或過期的任務（預設 30 分鐘後）。
-   **異步 API 端點 (`server.js`)**：
    -   提供專門的異步 API 端點來啟動長時間任務，例如：
        -   `POST /api/generate-article-url-async` (文章生成)
        -   `POST /api/analyze-video-url-async` (中繼資料生成)
    -   提供 `GET /api/task/:taskId` 端點供前端查詢任務狀態。
    -   提供 `DELETE /api/task/:taskId` 端點供取消任務。

### 前端

-   **任務輪詢服務 (`services/taskPollingService.ts`)**：
    -   負責定期向後端查詢特定任務的狀態。
    -   支援進度回調，以便在 UI 上顯示實時進度。
    -   處理任務超時和錯誤。
-   **異步 API 函數 (`services/videoApiService.ts`, `services/geminiService.ts`)**：
    -   提供異步版本的 API 呼叫，自動處理任務的創建和輪詢邏輯。
    -   例如 `generateArticleWithYouTubeUrlAsync()` 和 `generateVideoMetadataAsync()`。

## 🚀 用戶體驗

**無需改變使用習慣！** 系統已自動切換到異步模式。

現在您可以：
-   ✅ 在生成內容時自由切換分頁或應用程式。
-   ✅ 讓應用程式在背景運行。
-   ✅ 鎖定手機螢幕。
-   任務將在後端持續執行，完成後前端會顯示結果。

### 目前支援的異步功能

-   **文章生成** (公開影片)
-   **中繼資料生成** (標題、描述、標籤 - 公開影片)

**⚠️ 注意**：目前未列出影片的文章生成和截圖生成功能尚未完全支援異步模式。

## 🛠️ 開發者指南

### 測試異步任務

1.  **啟動伺服器**：
    ```bash
    npm run server
    ```
2.  **啟動前端**：
    ```bash
    npm run dev
    ```
3.  **測試場景**：
    -   **正常流程**：選擇公開影片，點擊「生成文章」，觀察進度並等待完成。
    -   **手機背景測試**：在手機上啟動任務後，立即切換到其他應用或鎖定螢幕，稍後返回檢查任務是否完成。

### 監控任務狀態

您可以使用瀏覽器開發者工具或 `curl` 命令來監控任務狀態：

```bash
# 替換 YOUR_TASK_ID 為實際的任務 ID
curl http://localhost:3001/api/task/YOUR_TASK_ID
```

## 📊 系統優點與限制

### 優點

-   **手機友好**：解決了手機端長時間請求中斷的問題。
-   **超時保護**：不受雲服務平台（如 Render）的 30 秒請求超時限制影響。
-   **進度可見**：前端可實時顯示任務進度。
-   **錯誤處理**：具備完善的錯誤處理和重試機制。
-   **無縫切換**：在保留原有同步 API 的同時，提供了異步選項。

### 限制

-   **任務持久性**：由於任務數據儲存在內存中，伺服器重啟會導致進行中的任務丟失。
-   **單機限制**：當前實現不支持多實例部署（可透過整合 Redis 等外部儲存解決）。
-   **內存使用**：大量並發任務可能增加內存消耗。

## 🚀 未來改進方向

-   **持久化儲存**：整合 Redis 或數據庫來儲存任務狀態，實現任務持久化和多實例支持。
-   **WebSocket 通知**：使用 WebSocket 替代輪詢，實現實時任務進度推送。
-   **任務隊列**：引入更 robust 的任務隊列系統，限制並發數量，避免資源耗盡。
-   **任務歷史**：保存已完成任務的歷史記錄供用戶查詢。

---

**相關文件**：
-   `services/taskQueue.js` (後端任務隊列核心)
-   `services/taskPollingService.ts` (前端任務輪詢服務)
-   `server.js` (異步 API 端點)

---

**注意**：此解決方案已在開發環境測試，建議在生產環境部署前進行完整測試。
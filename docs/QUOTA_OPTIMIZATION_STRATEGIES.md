# YouTube API é…é¡å„ªåŒ–ç­–ç•¥

## ğŸ”§ ç•¶å‰å¿«å–å¯¦ä½œæ–¹å¼

### æ¦‚è¿°

ç•¶å‰çš„å½±ç‰‡å¿«å–æ©Ÿåˆ¶ä½æ–¼ `services/videoCacheService.js`ï¼Œæ ¸å¿ƒåŠŸèƒ½æ˜¯ `fetchAllVideoTitles()` å‡½å¼ï¼Œæ¡ç”¨**å…©éšæ®µç­–ç•¥**ç²å–å®Œæ•´çš„å½±ç‰‡è³‡è¨Šä¸¦å„²å­˜è‡³ GitHub Gistã€‚

### å¯¦ä½œæµç¨‹

#### éšæ®µ 1: ç²å–åŸºæœ¬å½±ç‰‡è³‡è¨Šï¼ˆsearch.listï¼‰

ä½¿ç”¨ `youtube.search.list` API æœå°‹é »é“æ‰€æœ‰å½±ç‰‡ï¼š

```javascript
const response = await youtube.search.list({
  part: 'snippet',
  forMine: true,        // åªæœå°‹æˆ‘çš„å½±ç‰‡
  type: 'video',        // åªæœå°‹å½±ç‰‡é¡å‹
  order: 'date',        // æŒ‰ç™¼å¸ƒæ—¥æœŸæ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
  maxResults: 50,       // æ¯é  50 æ”¯å½±ç‰‡
  pageToken: pageToken, // ç”¨æ–¼ç¿»é 
});
```

**ç²å–çš„è³‡æ–™æ¬„ä½ï¼š**
- `videoId` - å½±ç‰‡ ID
- `title` - å½±ç‰‡æ¨™é¡Œ
- `publishedAt` - ç™¼å¸ƒæ™‚é–“
- `thumbnail` - ç¸®åœ– URL

**ç‰¹é»ï¼š**
- âœ… èƒ½å¤ æ‰¾åˆ°**æ‰€æœ‰å½±ç‰‡**ï¼ˆåŒ…æ‹¬ç§äººã€æœªåˆ—å‡ºï¼‰
- âœ… ä½¿ç”¨ `forMine: true` ç¢ºä¿æœå°‹ç•¶å‰æˆæ¬Šå¸³è™Ÿçš„å½±ç‰‡
- âœ… ä½¿ç”¨ `order: 'date'` æŒ‰ç™¼å¸ƒæ—¥æœŸæ’åº
- âš ï¸ **é…é¡æˆæœ¬æ¥µé«˜**ï¼šæ¯é  100 units
- âš ï¸ å¿…é ˆä¾åºç¿»é å–å¾—æ‰€æœ‰çµæœ
- âŒ **ä¸åŒ…å« tags å’Œ categoryId**ï¼ˆsearch.list çš„ snippet ä¸æä¾›é€™äº›æ¬„ä½ï¼‰

**é…é¡æˆæœ¬ï¼š**
```
2,819 æ”¯å½±ç‰‡ Ã· 50 æ”¯/é  = 57 é 
57 é  Ã— 100 units/é  = 5,700 units
```

#### éšæ®µ 2: æ‰¹æ¬¡ç²å–è©³ç´°è³‡è¨Šï¼ˆvideos.listï¼‰

ä½¿ç”¨ `youtube.videos.list` API æ‰¹æ¬¡ç²å–çµ±è¨ˆæ•¸æ“šã€ç‹€æ…‹å’Œæ¨™ç±¤ï¼š

```javascript
const statsResponse = await youtube.videos.list({
  part: 'statistics,status,snippet',  // ç²å–ä¸‰å€‹ part
  id: videoIds,                        // æœ€å¤š 50 å€‹ videoIdï¼ˆé€—è™Ÿåˆ†éš”ï¼‰
  maxResults: 50,
});
```

**ç²å–çš„è³‡æ–™æ¬„ä½ï¼š**

**å¾ statistics part (2 units):**
- `viewCount` - è§€çœ‹æ¬¡æ•¸
- `likeCount` - æŒ‰è®šæ•¸
- `commentCount` - ç•™è¨€æ•¸

**å¾ status part (2 units):**
- `privacyStatus` - éš±ç§ç‹€æ…‹ï¼ˆpublic, private, unlistedï¼‰

**å¾ snippet part (2 units):**
- `tags` - å½±ç‰‡æ¨™ç±¤ï¼ˆé™£åˆ—ï¼‰
- `categoryId` - å½±ç‰‡åˆ†é¡ ID

**é…é¡æˆæœ¬ï¼š**
```
æ¯æ‰¹æ¬¡ï¼šsnippet (2) + statistics (2) + status (2) = 6 units
ç¸½æ‰¹æ¬¡æ•¸ï¼š57 æ‰¹æ¬¡
ç¸½æˆæœ¬ï¼š57 Ã— 6 = 342 units
```

#### éšæ®µ 3: å»é‡èˆ‡å„²å­˜

```javascript
// å»é‡è™•ç†ï¼ˆä½¿ç”¨ Map ç¢ºä¿ videoId å”¯ä¸€ï¼‰
const videoMap = new Map();
videos.forEach(video => videoMap.set(video.videoId, video));
const uniqueVideos = Array.from(videoMap.values());

// ä¸Šå‚³è‡³ Gist
await uploadToGist(uniqueVideos, gistToken, gistId);
```

### æœ€çµ‚è³‡æ–™çµæ§‹

å„²å­˜è‡³ Gist çš„ JSON çµæ§‹ï¼š

```json
{
  "version": "1.0",
  "updatedAt": "2025-11-12T10:30:00.000Z",
  "totalVideos": 2819,
  "videos": [
    {
      "videoId": "abc123xyz",
      "title": "å½±ç‰‡æ¨™é¡Œ",
      "publishedAt": "2024-01-01T00:00:00Z",
      "thumbnail": "https://i.ytimg.com/vi/abc123xyz/mqdefault.jpg",
      "viewCount": 15000,
      "likeCount": 320,
      "commentCount": 45,
      "privacyStatus": "public",
      "tags": ["ç§‘æŠ€", "æ•™å­¸", "AI"],
      "categoryId": "28"
    }
  ]
}
```

### ç¸½é…é¡æˆæœ¬

```
æ­¥é©Ÿ 1: search.list
  57 é  Ã— 100 units/é  = 5,700 units

æ­¥é©Ÿ 2: videos.list
  57 æ‰¹æ¬¡ Ã— 6 units/æ‰¹æ¬¡ = 342 units
  (snippet:2 + statistics:2 + status:2)

ç¸½è¨ˆï¼š6,042 units (60.42%)
```

### å„ªé»èˆ‡ç¼ºé»

**å„ªé»ï¼š**
- âœ… **100% å®Œæ•´æ€§**ï¼šå¯ä»¥æ‰¾åˆ°æ‰€æœ‰å½±ç‰‡ï¼ˆåŒ…æ‹¬ç§äººã€æœªåˆ—å‡ºï¼‰
- âœ… **è³‡æ–™è±å¯Œ**ï¼šåŒ…å«çµ±è¨ˆæ•¸æ“šã€æ¨™ç±¤ã€åˆ†é¡ç­‰å®Œæ•´è³‡è¨Š
- âœ… **çµæ§‹æ¸…æ™°**ï¼šå…©éšæ®µåˆ†å·¥æ˜ç¢ºï¼Œæ˜“æ–¼ç†è§£å’Œç¶­è­·
- âœ… **å¯é æ€§é«˜**ï¼šä½¿ç”¨å®˜æ–¹ APIï¼Œä¸ä¾è³´æ’­æ”¾æ¸…å–®

**ç¼ºé»ï¼š**
- âŒ **é…é¡æˆæœ¬æ¥µé«˜**ï¼šå–®æ¬¡æ›´æ–°æ¶ˆè€— 60% æ¯æ—¥é…é¡
- âŒ **æ“´å±•æ€§å·®**ï¼šç•¶å½±ç‰‡æ•¸è¶…é 4,800 æ”¯æ™‚ï¼Œé…é¡ä¸è¶³ä»¥å®Œæˆä¸€æ¬¡æ›´æ–°
- âŒ **å¿…é ˆå®Œæ•´æ›´æ–°**ï¼šç„¡æ³•åªæ›´æ–°éƒ¨åˆ†å½±ç‰‡
- âŒ **ä¾åºç¿»é é™åˆ¶**ï¼šç„¡æ³•ä¸¦è¡Œè™•ç†æˆ–è·³éæŸäº›é é¢

### é©ç”¨å ´æ™¯

ç•¶å‰å¯¦ä½œé©åˆä»¥ä¸‹æƒ…æ³ï¼š
- âœ… å½±ç‰‡æ•¸é‡ < 3,000 æ”¯
- âœ… éœ€è¦ 100% è³‡æ–™å®Œæ•´æ€§
- âœ… å¯æ¥å—æ¯æ—¥ 60% é…é¡æ¶ˆè€—
- âœ… æ›´æ–°é »ç‡è¼ƒä½ï¼ˆæ¯æ—¥æˆ–æ›´é•·ï¼‰

---

## ğŸ“Š ç•¶å‰å•é¡Œåˆ†æ

### ç¾æ³
- **å½±ç‰‡æ•¸é‡**ï¼š2,819 æ”¯ï¼ˆä¸”æŒçºŒå¢é•·ï¼‰
- **æ¯æ—¥é…é¡é™åˆ¶**ï¼š10,000 units
- **ç•¶å‰é…é¡ä½¿ç”¨**ï¼š6,042 unitsï¼ˆ60%ï¼‰

### é…é¡æ¶ˆè€—æ˜ç´°
```
æ­¥é©Ÿ 1: search.list ç²å–åŸºæœ¬è³‡è¨Š
  - 57 é  Ã— 100 units/é  = 5,700 units

æ­¥é©Ÿ 2: videos.list ç²å–è©³ç´°è³‡è¨Š
  - 57 æ‰¹æ¬¡ Ã— 6 units/æ‰¹æ¬¡ = 342 units
  - (snippet:2 + statistics:2 + status:2)

ç¸½è¨ˆï¼š6,042 units (60.42%)
```

### æ“´å±•æ€§å•é¡Œ

| å½±ç‰‡æ•¸é‡ | search.list æˆæœ¬ | videos.list æˆæœ¬ | ç¸½æˆæœ¬ | é…é¡ä½¿ç”¨ç‡ |
|---------|-----------------|-----------------|--------|-----------|
| 2,819 æ”¯ | 5,700 units | 342 units | 6,042 units | 60% |
| 5,000 æ”¯ | 10,000 units | 600 units | 10,600 units | **106% âŒ** |
| 10,000 æ”¯ | 20,000 units | 1,200 units | 21,200 units | **212% âŒ** |

**çµè«–**ï¼šç•¶å½±ç‰‡æ•¸è¶…é 4,800 æ”¯æ™‚ï¼Œé€£ä¸€æ¬¡å®Œæ•´æ›´æ–°éƒ½ç„¡æ³•å®Œæˆã€‚

---

## ğŸ” API ç‰¹æ€§å°æ¯”

### 1. search.list

**ç‰¹é»ï¼š**
- âœ… å¯ä»¥æ‰¾åˆ°**æ‰€æœ‰æ“æœ‰çš„å½±ç‰‡**ï¼ˆåŒ…æ‹¬ç§äººã€æœªåˆ—å‡ºï¼‰
- âœ… æ”¯æ´ `forMine: true` åƒæ•¸
- âœ… æ”¯æ´æ™‚é–“ç¯„åœéæ¿¾ï¼ˆ`publishedAfter` / `publishedBefore`ï¼‰
- âœ… æ”¯æ´å¤šç¨®æ’åºæ–¹å¼
- âŒ é…é¡æˆæœ¬æ¥µé«˜ï¼ˆ**100 units/é **ï¼‰
- âŒ å¿…é ˆä¾åºç¿»é ï¼ˆç„¡æ³•è·³é ï¼‰

**é©ç”¨å ´æ™¯ï¼š**
- éœ€è¦ 100% å®Œæ•´æ€§
- éœ€è¦æœå°‹ç‰¹å®šé—œéµå­—
- å½±ç‰‡æ•¸é‡å°‘æ–¼ 5,000 æ”¯

**é…é¡æˆæœ¬ï¼š**
```javascript
æ¯é  50 æ”¯å½±ç‰‡ = 100 units
2,819 æ”¯å½±ç‰‡ = 57 é  = 5,700 units
```

---

### 2. playlistItems.list

**ç‰¹é»ï¼š**
- âœ… é…é¡æˆæœ¬ä½ï¼ˆ**2 units/é **ï¼Œæ¯” search.list ä¾¿å®œ 50 å€ï¼‰
- âœ… è‡ªå‹•æ’é™¤å·²åˆªé™¤çš„å½±ç‰‡
- âœ… å¯æ“´å±•åˆ° 50,000+ æ”¯å½±ç‰‡
- âš ï¸ å¯èƒ½æ¼æ‰ 1-5% çš„å½±ç‰‡ï¼ˆæ‰‹å‹•å¾æ’­æ”¾æ¸…å–®ç§»é™¤çš„ï¼‰
- âŒ ç„¡æ³•ç”¨é—œéµå­—æœå°‹

**é©ç”¨å ´æ™¯ï¼š**
- å½±ç‰‡æ•¸é‡å¤§æ–¼ 5,000 æ”¯
- å¯æ¥å— 1-5% çš„å·®ç•°
- æ—¥å¸¸å¿«é€Ÿæ›´æ–°

**é…é¡æˆæœ¬ï¼š**
```javascript
æ¯é  50 æ”¯å½±ç‰‡ = 2 units
2,819 æ”¯å½±ç‰‡ = 57 é  = 114 units
```

---

### 3. videos.list

**ç‰¹é»ï¼š**
- âœ… ç²å–è©³ç´°è³‡è¨Šï¼ˆtags, statistics, statusï¼‰
- âœ… å¯ç”¨æ–¼é©—è­‰å½±ç‰‡æ˜¯å¦å­˜åœ¨
- âœ… é…é¡æˆæœ¬å›ºå®šï¼ˆ**1-2 units/part**ï¼‰
- âŒ å¿…é ˆæä¾› videoIdï¼Œç„¡æ³•æœå°‹

**é…é¡æˆæœ¬ï¼š**
```javascript
part: 'id' = 1 unit
part: 'snippet' = 2 units
part: 'statistics' = 2 units
part: 'status' = 2 units
```

---

### 4. youtubeAnalytics.reports.query

**ç‰¹é»ï¼š**
- âœ… ç²å–è§€çœ‹æ•¸æ“šï¼ˆviews, likes, comments ç­‰ï¼‰
- âœ… é…é¡æˆæœ¬ä½ï¼ˆ**0-1 units**ï¼‰
- âœ… æ”¯æ´æ™‚é–“ç¯„åœéæ¿¾
- âš ï¸ **éœé»˜å¿½ç•¥å·²åˆªé™¤çš„å½±ç‰‡**ï¼ˆä¸æœƒè¿”å›æ•¸æ“šï¼Œä¹Ÿä¸å ±éŒ¯ï¼‰
- âš ï¸ æ²’æœ‰è§€çœ‹æ•¸æ“šçš„å½±ç‰‡ä¹Ÿä¸æœƒè¿”å›

**é‡è¦è¡Œç‚ºï¼š**
```javascript
// æŸ¥è©¢ 3 æ”¯å½±ç‰‡ï¼Œä½† video2 å·²è¢«åˆªé™¤
filters: 'video==video1,video2,video3'

// çµæœï¼š
{
  rows: [
    ['video1', 1000], // âœ… è¿”å›
    ['video3', 500],  // âœ… è¿”å›
    // video2 ä¸æœƒå‡ºç¾ âŒ
  ]
}

// æ³¨æ„ï¼š
// - ä¸æœƒæ‹‹å‡ºéŒ¯èª¤
// - ç„¡æ³•å€åˆ†ã€Œå·²åˆªé™¤ã€å’Œã€Œæ²’æœ‰è§€çœ‹æ•¸æ“šã€
```

---

## ğŸ’¡ å„ªåŒ–ç­–ç•¥æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šç´”å¢é‡æ›´æ–°

**ç­–ç•¥ï¼š**
- æ¯æ—¥åªæŠ“å–ã€Œæ–°ç™¼å¸ƒã€çš„å½±ç‰‡
- ä½¿ç”¨ `publishedAfter` åƒæ•¸

**å¯¦ä½œï¼š**
```javascript
const newVideos = await youtube.search.list({
  part: 'snippet',
  forMine: true,
  type: 'video',
  order: 'date',
  publishedAfter: cache.updatedAt, // ä¸Šæ¬¡æ›´æ–°æ™‚é–“
  maxResults: 50,
});
```

**é…é¡æˆæœ¬ï¼š**
```
æ¯æ—¥æ–°å½±ç‰‡ï¼ˆå‡è¨­ 1-2 æ”¯ï¼‰ï¼š
- 1 é  Ã— 100 units = 100 units (1%)

æ¯æœˆæˆæœ¬ï¼š
- æ¯æ—¥æ›´æ–°ï¼š100 Ã— 30 = 3,000 units
```

**å„ªé»ï¼š**
- âœ… é…é¡ä½¿ç”¨æ¥µä½ï¼ˆæ¯æ—¥ 1%ï¼‰
- âœ… ç°¡å–®æ˜“å¯¦ä½œ
- âœ… é©åˆæŒçºŒç¶­è­·

**ç¼ºé»ï¼š**
- âŒ ç„¡æ³•æª¢æ¸¬å·²åˆªé™¤çš„å½±ç‰‡
- âŒ å¿«å–ä¸­æœƒç´¯ç©ã€Œæ®­å±è³‡æ–™ã€
- âŒ éœ€è¦å®šæœŸå®Œæ•´æ›´æ–°

---

### æ–¹æ¡ˆ Bï¼šå®šæœŸå®Œæ•´æ›´æ–°

**ç­–ç•¥ï¼š**
- æ¯æ—¥å¢é‡æ›´æ–°ï¼ˆä½æˆæœ¬ï¼‰
- æ¯æœˆå®Œæ•´æ›´æ–°ï¼ˆæ¸…ç†åˆªé™¤çš„å½±ç‰‡ï¼‰

**å¯¦ä½œï¼š**
```javascript
const daysSinceFullUpdate = getDaysSince(cache.lastFullUpdate);

if (daysSinceFullUpdate >= 30) {
  // æ¯æœˆä¸€æ¬¡ï¼šå®Œæ•´æ›´æ–°
  return await fetchAllVideos(); // 6,042 units
} else {
  // æ¯æ—¥ï¼šå¢é‡æ›´æ–°
  return await incrementalUpdate(); // 100 units
}
```

**é…é¡æˆæœ¬ï¼š**
```
æ¯æœˆï¼š
- å¢é‡æ›´æ–°ï¼š100 Ã— 29 å¤© = 2,900 units
- å®Œæ•´æ›´æ–°ï¼š6,042 Ã— 1 æ¬¡ = 6,042 units
- ç¸½è¨ˆï¼š8,942 units

æœˆå¹³å‡æ¯æ—¥ï¼š8,942 / 30 = 298 units (3%)
```

**å„ªé»ï¼š**
- âœ… å¹³å‡é…é¡ä½¿ç”¨ä½ï¼ˆæ¯æ—¥ 3%ï¼‰
- âœ… æ¯æœˆç¢ºä¿æ•¸æ“šå®Œæ•´æ€§
- âœ… è‡ªå‹•æ¸…ç†å·²åˆªé™¤çš„å½±ç‰‡

**ç¼ºé»ï¼š**
- âš ï¸ æ¯æœˆæœ‰ä¸€å¤©æœƒç”¨æ‰ 60% é…é¡
- âŒ å½±ç‰‡æ•¸è¶…é 5,000 æ”¯æœƒçˆ†é…é¡

---

### æ–¹æ¡ˆ Cï¼šæ¼¸é€²å¼å»ºç«‹å¿«å–

**ç­–ç•¥ï¼š**
- æŒ‰å¹´ä»½åˆ†æ‰¹å»ºç«‹å¿«å–
- å„ªå…ˆæŠ“å–æœ€æ–°å½±ç‰‡
- ç”¨å‰©é¤˜é…é¡è£œå……èˆŠå½±ç‰‡

**å¯¦ä½œï¼š**
```javascript
// éšæ®µ 1: å»ºç«‹å¿«å–ï¼ˆåˆ† 5-7 å¤©ï¼‰
const years = [
  { label: '2021å¹´', start: '2021-01-01', end: '2021-12-31' },
  { label: '2022å¹´', start: '2022-01-01', end: '2022-12-31' },
  // ...
];

// æ¯å¤©è™•ç†ä¸€å€‹å¹´ä»½
const yearToProcess = years[cache.backfillIndex];

const videos = await youtube.search.list({
  publishedAfter: yearToProcess.start,
  publishedBefore: yearToProcess.end,
});

// éšæ®µ 2: ç¶­è­·å¿«å–ï¼ˆæ¯æ—¥ï¼‰
const newVideos = await incrementalUpdate(); // 100 units
```

**é…é¡æˆæœ¬ï¼š**
```
å»ºç«‹æœŸï¼ˆ5-7 å¤©ï¼‰ï¼š
- Day 1: æ–°å½±ç‰‡ (100) + 2024å¹´ (1,400) = 1,500 units (15%)
- Day 2: æ–°å½±ç‰‡ (100) + 2023å¹´ (1,400) = 1,500 units (15%)
- Day 3: æ–°å½±ç‰‡ (100) + 2022å¹´ (1,200) = 1,300 units (13%)
- Day 4: æ–°å½±ç‰‡ (100) + 2021å¹´ (800) = 900 units (9%)
- Day 5: æ–°å½±ç‰‡ (100) + 2020å¹´å‰ (1,000) = 1,100 units (11%)

ç¶­è­·æœŸï¼ˆå»ºç«‹å®Œæˆå¾Œï¼‰ï¼š
- æ¯æ—¥ï¼š100-200 units (1-2%)
```

**å„ªé»ï¼š**
- âœ… é…é¡ä½¿ç”¨å¹³å‡åˆ†æ•£
- âœ… ä¸æœƒå–®æ—¥çˆ†é…é¡
- âœ… å¯éš¨æ™‚æš«åœ/æ¢å¾©
- âœ… å„ªå…ˆç¢ºä¿æœ€æ–°è³‡æ–™
- âœ… å¯æ“´å±•åˆ° 10,000+ æ”¯å½±ç‰‡

**ç¼ºé»ï¼š**
- âš ï¸ å¯¦ä½œè¼ƒè¤‡é›œ
- âš ï¸ éœ€è¦è¿½è¹¤å»ºç«‹é€²åº¦

---

### æ–¹æ¡ˆ Dï¼šæ··åˆç­–ç•¥ï¼ˆplaylistItems.list + search.listï¼‰

**ç­–ç•¥ï¼š**
- ç”¨ playlistItems.list ç²å–å¤§éƒ¨åˆ†å½±ç‰‡ï¼ˆä½æˆæœ¬ï¼‰
- ç”¨ search.list å®šæœŸé©—è­‰å®Œæ•´æ€§ï¼ˆæ¯æœˆï¼‰

**å¯¦ä½œï¼š**
```javascript
// æ¯æ—¥ï¼šå¿«é€Ÿæ›´æ–°
const videos = await fetchViaPlaylistItems(); // 456 units (4.5%)

// æ¯æœˆï¼šå®Œæ•´é©—è­‰
const allVideos = await fetchViaSearch(); // 6,042 units (60%)
const missing = findMissingVideos(playlistVideos, allVideos);
```

**é…é¡æˆæœ¬ï¼š**
```
æ¯æœˆï¼š
- playlistItems.listï¼š456 Ã— 29 å¤© = 13,224 units
- search.listï¼š6,042 Ã— 1 æ¬¡ = 6,042 units
- ç¸½è¨ˆï¼š19,266 units

æœˆå¹³å‡æ¯æ—¥ï¼š19,266 / 30 = 642 units (6.4%)
```

**å„ªé»ï¼š**
- âœ… æ—¥å¸¸é…é¡ä½¿ç”¨ä½ï¼ˆ4.5%ï¼‰
- âœ… æ¯æœˆç¢ºä¿å®Œæ•´æ€§
- âœ… é©åˆå½±ç‰‡æ•¸é‡å¤šçš„æƒ…æ³

**ç¼ºé»ï¼š**
- âš ï¸ playlistItems.list å¯èƒ½æ¼ 1-5% å½±ç‰‡
- âš ï¸ éœ€è¦ç®¡ç†å…©ç¨®è³‡æ–™ä¾†æº

---

### æ–¹æ¡ˆ Eï¼šæ™ºèƒ½æ¸…ç†ï¼ˆåˆ©ç”¨ Analytics APIï¼‰

**ç­–ç•¥ï¼š**
- ç”¨ Analytics API æ‰¾å‡ºã€Œå¯ç–‘ã€çš„å½±ç‰‡
- ç”¨ videos.list é©—è­‰æ˜¯å¦çœŸçš„è¢«åˆªé™¤

**å¯¦ä½œï¼š**
```javascript
// 1. æŸ¥è©¢æ‰€æœ‰å½±ç‰‡çš„ Analytics æ•¸æ“š
const analyticsData = await youtubeAnalytics.reports.query({
  filters: `video==${allVideoIds.join(',')}`,
  metrics: 'views',
});

// 2. æ‰¾å‡ºæ²’æœ‰è¿”å›æ•¸æ“šçš„å½±ç‰‡ï¼ˆå¯ç–‘ï¼‰
const suspiciousIds = allVideoIds.filter(id =>
  !analyticsData.has(id)
);

// 3. ç”¨ videos.list é©—è­‰ï¼ˆä½æˆæœ¬ï¼‰
const stillExist = await youtube.videos.list({
  part: 'id',
  id: suspiciousIds.join(','),
});
// æˆæœ¬ï¼šsuspiciousIds.length / 50 Ã— 1 unit

// 4. ç§»é™¤å·²åˆªé™¤çš„å½±ç‰‡
const validVideos = cache.videos.filter(v =>
  analyticsData.has(v.videoId) || stillExist.has(v.videoId)
);
```

**é…é¡æˆæœ¬ï¼š**
```
å‡è¨­ 100 æ”¯å½±ç‰‡ã€Œå¯ç–‘ã€ï¼š
- Analytics æŸ¥è©¢ï¼š0 unitsï¼ˆæœ¬ä¾†å°±è¦æŸ¥ï¼‰
- videos.list é©—è­‰ï¼š100 / 50 Ã— 1 = 2 units

é¡å¤–æˆæœ¬æ¥µä½ï¼
```

**å„ªé»ï¼š**
- âœ… é…é¡æˆæœ¬æ¥µä½
- âœ… å¯ç²¾æº–æ¸…ç†å·²åˆªé™¤å½±ç‰‡
- âœ… å¯çµåˆä»»ä½•å…¶ä»–æ–¹æ¡ˆ

**ç¼ºé»ï¼š**
- âš ï¸ ç„¡æ³•å€åˆ†ã€Œå·²åˆªé™¤ã€å’Œã€Œæ²’æœ‰è§€çœ‹æ•¸æ“šã€
- âš ï¸ éœ€è¦é¡å¤–é‚è¼¯åˆ¤æ–·

---

## ğŸ“‹ API åƒæ•¸èªªæ˜

### search.list å¸¸ç”¨åƒæ•¸

```javascript
await youtube.search.list({
  part: 'snippet',           // å¿…å¡«
  forMine: true,             // åªæœå°‹æˆ‘çš„å½±ç‰‡
  type: 'video',             // åªæœå°‹å½±ç‰‡ï¼ˆä¸å«æ’­æ”¾æ¸…å–®ç­‰ï¼‰
  order: 'date',             // æ’åºæ–¹å¼
  maxResults: 50,            // æ¯é æ•¸é‡ï¼ˆæœ€å¤š 50ï¼‰
  pageToken: 'xxx',          // ç¿»é  token
  publishedAfter: 'xxx',     // ç™¼å¸ƒæ™‚é–“ç¯©é¸
  publishedBefore: 'xxx',    // ç™¼å¸ƒæ™‚é–“ç¯©é¸
  q: 'keyword',              // é—œéµå­—æœå°‹
});
```

### order åƒæ•¸é¸é …

| å€¼ | èªªæ˜ | é©ç”¨å ´æ™¯ |
|---|------|---------|
| `date` | æŒ‰ç™¼å¸ƒæ—¥æœŸï¼ˆé™åºï¼Œæœ€æ–°åœ¨å‰ï¼‰ | å¢é‡æ›´æ–°ã€æ™‚é–“åºåˆ—åˆ†æ |
| `relevance` | æŒ‰ç›¸é—œæ€§ï¼ˆé è¨­å€¼ï¼‰ | é—œéµå­—æœå°‹ |
| `rating` | æŒ‰è©•åˆ† | æ‰¾é«˜è©•åƒ¹å½±ç‰‡ |
| `title` | æŒ‰æ¨™é¡Œå­—æ¯é †åº | æŒ‰å­—æ¯æ’åº |
| `viewCount` | æŒ‰è§€çœ‹æ¬¡æ•¸ï¼ˆé™åºï¼‰ | æ‰¾ç†±é–€å½±ç‰‡ |
| `videoCount` | æŒ‰å½±ç‰‡æ•¸é‡ | åƒ…ç”¨æ–¼é »é“æœå°‹ |

### âš¡ é…é¡å„ªåŒ–çš„é—œéµæ¦‚å¿µ

#### é‡è¦ï¼šorder åƒæ•¸ä¸å½±éŸ¿é…é¡æˆæœ¬

**å¸¸è¦‹èª¤è§£ï¼š**
å¾ˆå¤šäººä»¥ç‚ºæ”¹è®Š `order` åƒæ•¸å¯ä»¥ç¯€çœé…é¡ï¼Œä¾‹å¦‚ã€Œç”¨ `order: 'relevance'` æœƒæ¯” `order: 'date'` çœé…é¡ã€ã€‚

**äº‹å¯¦ï¼š**
search.list çš„é…é¡æˆæœ¬**åªå–æ±ºæ–¼ç¿»é æ¬¡æ•¸**ï¼Œèˆ‡æ’åºæ–¹å¼ç„¡é—œï¼š

```javascript
// é€™äº›é…é¡æˆæœ¬å®Œå…¨ç›¸åŒï¼š
order: 'date'      // 100 units/é 
order: 'relevance' // 100 units/é 
order: 'viewCount' // 100 units/é 
```

#### çœŸæ­£ç¯€çœé…é¡çš„æ–¹æ³•ï¼šä½¿ç”¨ q åƒæ•¸éæ¿¾

**`q` åƒæ•¸çš„ä½œç”¨ï¼š**
é€éé—œéµå­—éæ¿¾ï¼Œ**æ¸›å°‘è¿”å›çš„å½±ç‰‡æ•¸é‡**ï¼Œå¾è€Œæ¸›å°‘ç¿»é æ¬¡æ•¸ã€‚

**å¯¦éš›ç¯„ä¾‹ï¼š**

å‡è¨­ä½ çš„é »é“æœ‰ 2,800 æ”¯å½±ç‰‡ï¼Œå…¶ä¸­åŒ…å«ã€Œç§‘æŠ€æ•™å­¸ã€é—œéµå­—çš„æœ‰ 100 æ”¯ã€‚

```javascript
// âŒ æƒ…æ³ 1ï¼šæ²’æœ‰é—œéµå­—éæ¿¾ï¼ˆæŠ“å–å…¨éƒ¨å½±ç‰‡ï¼‰
await youtube.search.list({
  part: 'snippet',
  forMine: true,
  type: 'video',
  order: 'date',        // æˆ–ä»»ä½• order å€¼
  maxResults: 50,
});
// çµæœï¼šè¿”å›å…¨éƒ¨ 2,800 æ”¯å½±ç‰‡
// é æ•¸ï¼š2,800 Ã· 50 = 56 é 
// é…é¡ï¼š56 Ã— 100 = 5,600 units
```

```javascript
// âœ… æƒ…æ³ 2ï¼šåŠ ä¸Šé—œéµå­—éæ¿¾
await youtube.search.list({
  part: 'snippet',
  forMine: true,
  type: 'video',
  q: 'ç§‘æŠ€æ•™å­¸',        // ğŸ‘ˆ é—œéµï¼éæ¿¾åªè¿”å›åŒ¹é…çš„å½±ç‰‡
  order: 'relevance',  // æ’åºä¸å½±éŸ¿é…é¡
  maxResults: 50,
});
// çµæœï¼šåªè¿”å›åŒ…å«ã€Œç§‘æŠ€æ•™å­¸ã€çš„ 100 æ”¯å½±ç‰‡
// é æ•¸ï¼š100 Ã· 50 = 2 é 
// é…é¡ï¼š2 Ã— 100 = 200 units
// ğŸ‰ ç¯€çœ 96.4% é…é¡ï¼
```

#### é…é¡å„ªåŒ–å°æ¯”è¡¨

| é…ç½® | è¿”å›å½±ç‰‡æ•¸ | é æ•¸ | é…é¡æˆæœ¬ | ç¯€çœ |
|------|-----------|------|---------|------|
| `forMine: true`<br>`order: 'date'` | 2,800 æ”¯ | 56 é  | **5,600 units** | - |
| `forMine: true`<br>`order: 'relevance'` | 2,800 æ”¯ | 56 é  | **5,600 units** | **0%** âŒ |
| `forMine: true`<br>`q: 'ç§‘æŠ€æ•™å­¸'`<br>`order: 'relevance'` | 100 æ”¯ | 2 é  | **200 units** | **96.4%** âœ… |
| `forMine: true`<br>`q: 'ç§‘æŠ€æ•™å­¸'`<br>`order: 'date'` | 100 æ”¯ | 2 é  | **200 units** | **96.4%** âœ… |
| `forMine: true`<br>`publishedAfter: '2025-01-01'`<br>`order: 'date'` | 10 æ”¯ | 1 é  | **100 units** | **98.2%** âœ… |

#### é—œéµçµè«–

1. **`order` åƒæ•¸**
   - âœ… ç”¨é€”ï¼šæ”¹è®Šçµæœæ’åºæ–¹å¼
   - âŒ **ä¸å½±éŸ¿é…é¡æˆæœ¬**
   - é¸æ“‡å»ºè­°ï¼š
     - æœ‰ `q` é—œéµå­— â†’ ç”¨ `order: 'relevance'`ï¼ˆæœ€ç›¸é—œçš„åœ¨å‰ï¼‰
     - æ²’æœ‰ `q` é—œéµå­— â†’ ç”¨ `order: 'date'`ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰

2. **çœŸæ­£çœé…é¡çš„åƒæ•¸**
   - âœ… `q`ï¼šé—œéµå­—éæ¿¾ï¼ˆæ¸›å°‘çµæœæ•¸é‡ï¼‰
   - âœ… `publishedAfter` / `publishedBefore`ï¼šæ™‚é–“ç¯„åœéæ¿¾ï¼ˆæ¸›å°‘çµæœæ•¸é‡ï¼‰
   - âœ… æ”¹ç”¨ `playlistItems.list`ï¼šAPI æœ¬èº«æˆæœ¬æ›´ä½ï¼ˆ2 units/é  vs 100 units/é ï¼‰

3. **å¯¦å‹™æ‡‰ç”¨**
   - **å»ºç«‹å®Œæ•´å¿«å–**ï¼šä¸èƒ½ç”¨ `q` éæ¿¾ï¼Œå¿…é ˆä»˜å‡ºå®Œæ•´é…é¡æˆæœ¬
   - **æœå°‹ç‰¹å®šä¸»é¡Œ**ï¼šç”¨ `q` åƒæ•¸å¤§å¹…é™ä½é…é¡æ¶ˆè€—
   - **å¢é‡æ›´æ–°**ï¼šç”¨ `publishedAfter` åªæŠ“æ–°å½±ç‰‡

#### type åƒæ•¸èªªæ˜

`type` åƒæ•¸é™åˆ¶æœå°‹çš„è³‡æºé¡å‹ï¼š

| å€¼ | èªªæ˜ | ç”¨é€” |
|---|------|------|
| `video` | åªæœå°‹å½±ç‰‡ | å»ºç«‹å½±ç‰‡å¿«å–ï¼ˆç•¶å‰ä½¿ç”¨ï¼‰ |
| `channel` | åªæœå°‹é »é“ | æœå°‹é »é“è³‡è¨Š |
| `playlist` | åªæœå°‹æ’­æ”¾æ¸…å–® | æœå°‹æ’­æ”¾æ¸…å–® |
| `video,playlist` | å¯çµ„åˆå¤šç¨®é¡å‹ | åŒæ™‚æœå°‹å½±ç‰‡å’Œæ’­æ”¾æ¸…å–® |

**é‡è¦ï¼š**
åœ¨ videoCacheService.js ä¸­ä½¿ç”¨ `type: 'video'` æ˜¯å¿…è¦çš„ï¼š
- âœ… ç¢ºä¿æ‰€æœ‰çµæœéƒ½æ˜¯å½±ç‰‡ï¼ˆæœ‰ `item.id.videoId`ï¼‰
- âœ… é¿å…è¿”å›é »é“ï¼ˆæœƒæœ‰ `item.id.channelId`ï¼‰æˆ–æ’­æ”¾æ¸…å–®
- âœ… é…åˆ `item.id.videoId` å®‰å…¨å–å¾—å½±ç‰‡ ID

---

## ğŸ¯ æ–¹æ¡ˆé¸æ“‡å»ºè­°

### å½±ç‰‡æ•¸é‡ < 3,000 æ”¯ï¼ˆç•¶å‰ç‹€æ³ï¼‰

**æ¨è–¦ï¼šæ–¹æ¡ˆ Bï¼ˆå®šæœŸå®Œæ•´æ›´æ–°ï¼‰**

```
é…é¡ä½¿ç”¨ï¼š3% å¹³å‡æ¯æ—¥
å¯¦ä½œé›£åº¦ï¼šâ­â­ ç°¡å–®
ç¶­è­·æˆæœ¬ï¼šä½
å®Œæ•´æ€§ï¼šâœ… 100%ï¼ˆæ¯æœˆé©—è­‰ä¸€æ¬¡ï¼‰
```

**ç†ç”±ï¼š**
- é…é¡å……è¶³ï¼ˆæ¯æ—¥ 3% vs 10% é¤˜è£•ï¼‰
- å¯¦ä½œç°¡å–®ï¼Œæ˜“æ–¼ç¶­è­·
- æ¯æœˆè‡ªå‹•æ¸…ç†åˆªé™¤çš„å½±ç‰‡

---

### å½±ç‰‡æ•¸é‡ 3,000 - 5,000 æ”¯

**æ¨è–¦ï¼šæ–¹æ¡ˆ Cï¼ˆæ¼¸é€²å¼å»ºç«‹ï¼‰**

```
é…é¡ä½¿ç”¨ï¼š10-15% å»ºç«‹æœŸï¼Œ1-2% ç¶­è­·æœŸ
å¯¦ä½œé›£åº¦ï¼šâ­â­â­ ä¸­ç­‰
ç¶­è­·æˆæœ¬ï¼šä¸­
å®Œæ•´æ€§ï¼šâœ… 100%ï¼ˆæ¼¸é€²å¼é©—è­‰ï¼‰
```

**ç†ç”±ï¼š**
- é¿å…å–®æ—¥çˆ†é…é¡
- å¯é€æ­¥å»ºç«‹å®Œæ•´å¿«å–
- é©åˆé€æ¼¸å¢é•·çš„é »é“

---

### å½±ç‰‡æ•¸é‡ > 5,000 æ”¯

**æ¨è–¦ï¼šæ–¹æ¡ˆ Dï¼ˆæ··åˆç­–ç•¥ï¼‰**

```
é…é¡ä½¿ç”¨ï¼š4.5% æ¯æ—¥ï¼Œ6.4% å¹³å‡
å¯¦ä½œé›£åº¦ï¼šâ­â­â­â­ è¼ƒè¤‡é›œ
ç¶­è­·æˆæœ¬ï¼šä¸­
å®Œæ•´æ€§ï¼šâš ï¸ 95-99%ï¼ˆå¯æ¥å—ï¼‰
```

**ç†ç”±ï¼š**
- playlistItems.list æˆæœ¬ä½ï¼Œå¯æ“´å±•
- å®šæœŸç”¨ search.list é©—è­‰å®Œæ•´æ€§
- å”¯ä¸€å¯æ”¯æ´ 10,000+ æ”¯å½±ç‰‡çš„æ–¹æ¡ˆ

---

### è¿½æ±‚æ¥µè‡´é…é¡æ•ˆç‡

**æ¨è–¦ï¼šæ–¹æ¡ˆ A + æ–¹æ¡ˆ E**

```
é…é¡ä½¿ç”¨ï¼š1-2% æ¯æ—¥
å¯¦ä½œé›£åº¦ï¼šâ­â­â­â­â­ è¤‡é›œ
ç¶­è­·æˆæœ¬ï¼šé«˜
å®Œæ•´æ€§ï¼šâš ï¸ éœ€è¦æ‰‹å‹•è™•ç†é‚Šç·£æƒ…æ³
```

**ç†ç”±ï¼š**
- é…é¡ä½¿ç”¨æœ€ä½
- é©åˆé…é¡å—é™çš„æƒ…æ³
- éœ€è¦è™•ç†è¤‡é›œçš„é‚Šç·£æƒ…æ³

---

## ğŸ”§ å¯¦ä½œè€ƒé‡

### 1. æ™‚å€è™•ç†

```javascript
// âœ… æ­£ç¢ºï¼šä½¿ç”¨ ISO 8601 æ ¼å¼ï¼ˆUTCï¼‰
const publishedAfter = new Date('2024-01-01T00:00:00Z').toISOString();
// "2024-01-01T00:00:00.000Z"

// âŒ éŒ¯èª¤ï¼šä½¿ç”¨æœ¬åœ°æ™‚é–“
const publishedAfter = '2024-01-01'; // å¯èƒ½è¢«è§£æç‚ºæœ¬åœ°æ™‚é–“
```

### 2. å¿«å–ç‹€æ…‹è¿½è¹¤

å»ºè­°åœ¨ Gist å¿«å–ä¸­åŠ å…¥ä»¥ä¸‹æ¬„ä½ï¼š

```javascript
{
  version: '2.0',
  updatedAt: '2024-12-01T10:30:00Z',
  lastFullUpdate: '2024-12-01T00:00:00Z',

  // æ¼¸é€²å¼å»ºç«‹ç›¸é—œ
  backfillComplete: false,
  backfillIndex: 2,
  backfillProgress: {
    years: ['2021', '2022', '2023', '2024', '2025'],
    processedYears: ['2024', '2025'],
  },

  // çµ±è¨ˆè³‡è¨Š
  totalVideos: 2819,
  deletedVideosCount: 45,
  lastCleanup: '2024-12-01T00:00:00Z',

  videos: [...]
}
```

### 3. éŒ¯èª¤è™•ç†

```javascript
try {
  const videos = await youtube.search.list({...});
} catch (error) {
  if (error.message.includes('quota')) {
    // é…é¡ç”¨ç›¡
    console.error('âŒ é…é¡å·²ç”¨ç›¡ï¼Œç­‰å¾…æ˜å¤©é‡è©¦');
    // ä¿å­˜ç•¶å‰é€²åº¦
    await saveProgress(cache);
  } else if (error.message.includes('403')) {
    // æ¬Šé™å•é¡Œ
    console.error('âŒ æ¬Šé™ä¸è¶³æˆ– token éæœŸ');
  } else {
    // å…¶ä»–éŒ¯èª¤
    throw error;
  }
}
```

### 4. é‡è©¦æ©Ÿåˆ¶

```javascript
async function fetchWithRetry(fn, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (i === maxRetries - 1) throw error;

      // æŒ‡æ•¸é€€é¿
      const delay = Math.pow(2, i) * 1000;
      console.log(`âš ï¸ é‡è©¦ä¸­... (${i + 1}/${maxRetries})`);
      await sleep(delay);
    }
  }
}
```

---

## ğŸ“Š é…é¡ç›£æ§å»ºè­°

### 1. æ¯æ—¥é…é¡ä½¿ç”¨è¿½è¹¤

```javascript
// åœ¨æ¯æ¬¡ API å‘¼å«å¾Œè¨˜éŒ„
const quotaLog = {
  date: '2024-12-01',
  operations: [
    { time: '10:00', api: 'search.list', cost: 100, context: 'incremental' },
    { time: '10:05', api: 'videos.list', cost: 6, context: 'details' },
  ],
  totalUsed: 106,
  remaining: 9894,
};
```

### 2. é…é¡è­¦å ±

```javascript
if (dailyQuotaUsed > 8000) {
  console.warn('âš ï¸ é…é¡ä½¿ç”¨è¶…é 80%ï¼Œä»Šæ—¥åœæ­¢éå¿…è¦æ“ä½œ');
}

if (dailyQuotaUsed > 9500) {
  console.error('âŒ é…é¡å³å°‡ç”¨ç›¡ï¼Œåœæ­¢æ‰€æœ‰æ“ä½œ');
  throw new Error('Quota limit reached');
}
```

---

## ğŸš€ é·ç§»è¨ˆç•«å»ºè­°

### éšæ®µ 1ï¼šè©•ä¼°èˆ‡æº–å‚™ï¼ˆ1-2 å¤©ï¼‰
1. åˆ†æç•¶å‰å½±ç‰‡åˆ†å¸ƒï¼ˆæŒ‰å¹´ä»½çµ±è¨ˆï¼‰
2. é ä¼°å„å¹´ä»½çš„é…é¡æˆæœ¬
3. é¸æ“‡é©åˆçš„æ–¹æ¡ˆ
4. å‚™ä»½ç¾æœ‰å¿«å–

### éšæ®µ 2ï¼šå¯¦ä½œæ–°ç­–ç•¥ï¼ˆ3-5 å¤©ï¼‰
1. å¯¦ä½œå¢é‡æ›´æ–°é‚è¼¯
2. å¯¦ä½œé€²åº¦è¿½è¹¤æ©Ÿåˆ¶
3. å¯¦ä½œéŒ¯èª¤è™•ç†èˆ‡é‡è©¦
4. æ¸¬è©¦å„ç¨®é‚Šç·£æƒ…æ³

### éšæ®µ 3ï¼šå»ºç«‹å®Œæ•´å¿«å–ï¼ˆ5-7 å¤©ï¼‰
1. åŸ·è¡Œæ¼¸é€²å¼å»ºç«‹ï¼ˆå¦‚æœé¸æ“‡æ–¹æ¡ˆ Cï¼‰
2. é©—è­‰æ•¸æ“šå®Œæ•´æ€§
3. æ¯”å°æ–°èˆŠå¿«å–å·®ç•°

### éšæ®µ 4ï¼šåˆ‡æ›åˆ°ç¶­è­·æ¨¡å¼
1. ç¢ºèªå¿«å–å®Œæ•´
2. åˆ‡æ›åˆ°å¢é‡æ›´æ–°æ¨¡å¼
3. ç›£æ§é…é¡ä½¿ç”¨æƒ…æ³

---

## ğŸ“š åƒè€ƒè³‡æº

- [YouTube Data API é…é¡èªªæ˜](https://developers.google.com/youtube/v3/getting-started#quota)
- [search.list API æ–‡ä»¶](https://developers.google.com/youtube/v3/docs/search/list)
- [playlistItems.list API æ–‡ä»¶](https://developers.google.com/youtube/v3/docs/playlistItems/list)
- [videos.list API æ–‡ä»¶](https://developers.google.com/youtube/v3/docs/videos/list)
- [YouTube Analytics API æ–‡ä»¶](https://developers.google.com/youtube/analytics/v2)

---

## ğŸ’¡ æœ€çµ‚å»ºè­°

**çŸ­æœŸæ–¹æ¡ˆï¼ˆç«‹å³å¯ç”¨ï¼‰ï¼š**
- å¯¦ä½œ**æ–¹æ¡ˆ B**ï¼ˆå®šæœŸå®Œæ•´æ›´æ–°ï¼‰
- é…é¡ä½¿ç”¨ï¼š3% å¹³å‡æ¯æ—¥
- æ™‚ç¨‹ï¼š1-2 å¤©å¯¦ä½œå®Œæˆ

**é•·æœŸæ–¹æ¡ˆï¼ˆæœªä¾†æ“´å±•ï¼‰ï¼š**
- ç•¶å½±ç‰‡æ•¸è¶…é 4,000 æ”¯æ™‚
- åˆ‡æ›åˆ°**æ–¹æ¡ˆ C**ï¼ˆæ¼¸é€²å¼å»ºç«‹ï¼‰æˆ–**æ–¹æ¡ˆ D**ï¼ˆæ··åˆç­–ç•¥ï¼‰
- é…é¡ä½¿ç”¨ï¼š1-2% ç¶­è­·æœŸ
- å¯æ“´å±•åˆ° 10,000+ æ”¯å½±ç‰‡

---

*æœ€å¾Œæ›´æ–°ï¼š2025-11-12*
*æ–‡ä»¶ç‰ˆæœ¬ï¼š1.0*
